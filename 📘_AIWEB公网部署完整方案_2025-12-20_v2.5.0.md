# 📘 AIWEB公网部署完整方案

**版本：** v2.5.0  
**日期：** 2025-12-20  
**文档类型：** 互联网公开访问部署指南

---

## 📋 目录

1. [部署方案对比](#部署方案对比)
2. [云服务器部署](#云服务器部署)
3. [CDN加速方案](#cdn加速方案)
4. [域名与SSL配置](#域名与ssl配置)
5. [安全加固](#安全加固)
6. [费用预算](#费用预算)
7. [部署流程](#部署流程)
8. [运维监控](#运维监控)

---

## 1. 部署方案对比

### 1.1 方案选择矩阵

| 方案 | 适用场景 | 优点 | 缺点 | 成本/年 |
|-----|---------|------|------|--------|
| **阿里云ECS** | 企业级应用 | 稳定、可扩展 | 配置复杂 | ¥3,000-15,000 |
| **腾讯云CVM** | 企业级应用 | 性价比高 | 网络速度 | ¥2,500-12,000 |
| **华为云ECS** | 政企客户 | 安全合规 | 价格较高 | ¥3,500-18,000 |
| **Vercel** | 前端静态托管 | 免费、快速 | 后端受限 | ¥0-2,000 |
| **Netlify** | JAMstack应用 | 简单易用 | 功能有限 | ¥0-1,500 |
| **Railway** | 全栈应用 | 自动部署 | 流量限制 | ¥0-800 |

### 1.2 推荐方案

#### 🏆 推荐方案一：阿里云ECS + OSS + CDN（企业级）

**适合**：
- 日访问量 > 1000
- 需要高可用性
- 有技术团队维护

**架构**：
```
用户 → CDN → 负载均衡 → ECS集群 → RDS数据库
                            ↓
                          OSS存储
```

#### 🥈 推荐方案二：Vercel + Serverless（轻量级）

**适合**：
- 中小型网站
- 预算有限
- 流量不大（< 100GB/月）

**架构**：
```
用户 → Vercel CDN → 静态页面
                  → Serverless Functions (API)
                  → 云数据库
```

---

## 2. 云服务器部署

### 2.1 阿里云ECS部署方案

#### 配置选择

**入门版（个人/小团队）**
| 配置项 | 规格 | 价格/年 |
|-------|------|---------|
| **实例类型** | ecs.t6-c1m2.large | ¥588 |
| **CPU** | 2核 | - |
| **内存** | 4GB | - |
| **系统盘** | 40GB ESSD | ¥120 |
| **数据盘** | 100GB 高效云盘 | ¥360 |
| **带宽** | 5Mbps | ¥600 |
| **总计** | - | **¥1,668/年** |

**标准版（中小企业）**
| 配置项 | 规格 | 价格/年 |
|-------|------|---------|
| **实例类型** | ecs.c6.xlarge | ¥3,500 |
| **CPU** | 4核 | - |
| **内存** | 8GB | - |
| **系统盘** | 100GB ESSD | ¥300 |
| **数据盘** | 500GB SSD | ¥2,400 |
| **带宽** | 10Mbps | ¥1,200 |
| **负载均衡** | SLB标准版 | ¥1,800 |
| **总计** | - | **¥9,200/年** |

**企业版（大型企业）**
| 配置项 | 规格 | 价格/年 |
|-------|------|---------|
| **ECS实例** | 2台 ecs.c6.2xlarge | ¥14,000 |
| **CPU** | 8核 × 2 | - |
| **内存** | 16GB × 2 | - |
| **RDS数据库** | MySQL 8.0 高可用 | ¥8,000 |
| **OSS存储** | 1TB 标准存储 | ¥1,500 |
| **CDN流量** | 10TB/年 | ¥3,000 |
| **负载均衡** | SLB高性能 | ¥3,600 |
| **WAF防护** | Web应用防火墙 | ¥9,600 |
| **总计** | - | **¥39,700/年** |

#### 部署步骤

**步骤1：购买ECS实例**
```bash
# 登录阿里云控制台
# https://ecs.console.aliyun.com

# 选择区域：根据用户分布选择
# 华北2（北京）、华东2（上海）、华南1（深圳）

# 实例配置
镜像：Ubuntu 22.04 64位
实例类型：按上表选择
网络：专有网络VPC
公网IP：分配
安全组：新建（后续配置）
```

**步骤2：配置安全组**
```bash
# 入方向规则
22/TCP    源：您的IP    （SSH访问）
80/TCP    源：0.0.0.0/0  （HTTP）
443/TCP   源：0.0.0.0/0  （HTTPS）
3000/TCP  源：内网      （前端服务）
3001/TCP  源：内网      （后端API）
```

**步骤3：连接服务器**
```bash
# 使用SSH连接
ssh root@your-server-ip

# 更新系统
apt update && apt upgrade -y

# 安装基础工具
apt install -y curl wget git vim build-essential
```

**步骤4：安装运行环境**
```bash
# 安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# 安装Nginx
apt install -y nginx

# 安装PM2
npm install -g pm2

# 验证安装
node --version
nginx -v
pm2 --version
```

**步骤5：部署代码**
```bash
# 克隆代码
cd /var/www
git clone https://github.com/your-org/AIWEB1.git
cd AIWEB1

# 安装依赖
npm install --production

# 构建前端
npm run build

# 启动后端
cd server
pm2 start index.js --name aiweb-api

# 配置开机自启
pm2 startup
pm2 save
```

**步骤6：配置Nginx**
```nginx
# /etc/nginx/sites-available/aiweb
server {
    listen 80;
    server_name your-domain.com;

    # 强制HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书（后续配置）
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # SSL优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;

    # 前端静态文件
    location / {
        root /var/www/AIWEB1/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
        
        # 缓存设置
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:3001/;
        proxy_http_version 1.1;
        
        # 代理头
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 上传文件访问
    location /uploads/ {
        alias /var/www/AIWEB1/server/uploads/;
        expires 30d;
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# 启用配置
ln -s /etc/nginx/sites-available/aiweb /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

### 2.2 腾讯云CVM部署方案

#### 配置对比
| 规格 | 腾讯云 | 阿里云 | 价格优势 |
|-----|-------|-------|---------|
| **2核4GB** | ¥1,200/年 | ¥1,668/年 | 腾讯云便宜28% |
| **4核8GB** | ¥2,800/年 | ¥3,500/年 | 腾讯云便宜20% |
| **8核16GB** | ¥6,500/年 | ¥8,000/年 | 腾讯云便宜19% |

#### 特色功能
- **轻量应用服务器**：集成环境，一键部署
- **云开发CloudBase**：Serverless后端服务
- **对象存储COS**：图片、视频存储

### 2.3 华为云ECS部署方案

#### 优势
- ✅ **政企认证**：通过多项安全认证
- ✅ **国产化**：支持国产芯片和操作系统
- ✅ **合规性**：满足等保2.0要求

#### 适用场景
- 政府项目
- 国企央企
- 金融、医疗等强监管行业

---

## 3. CDN加速方案

### 3.1 为什么需要CDN？

| 优势 | 说明 | 效果 |
|-----|------|------|
| **加速访问** | 就近访问边缘节点 | 延迟降低60-80% |
| **降低成本** | 减少源站带宽消耗 | 节省40-70%带宽费用 |
| **抗攻击** | DDoS防护、CC防护 | 提升安全性 |
| **提升体验** | 秒开、流畅 | 用户满意度↑ |

### 3.2 CDN配置步骤（以阿里云为例）

**步骤1：开通CDN服务**
```bash
# 登录阿里云CDN控制台
https://cdn.console.aliyun.com

# 购买流量包（可选）
100GB流量包：¥17/月
1TB流量包：¥142/月
10TB流量包：¥1,280/月
```

**步骤2：添加加速域名**
```bash
# 加速域名：static.your-domain.com
# 源站类型：OSS域名 或 IP地址
# 源站地址：your-server-ip 或 bucket.oss-cn-beijing.aliyuncs.com
# 加速区域：中国大陆 / 全球
```

**步骤3：配置CNAME**
```bash
# 获取CDN分配的CNAME
# 示例：static.your-domain.com.w.kunlunsl.com

# 到域名服务商添加CNAME记录
记录类型：CNAME
主机记录：static
记录值：static.your-domain.com.w.kunlunsl.com
TTL：10分钟
```

**步骤4：优化配置**
```bash
# 缓存配置
目录：/static/*     过期时间：30天
目录：/assets/*    过期时间：365天
目录：/uploads/*   过期时间：30天
文件：*.html       过期时间：1小时
文件：*.js,*.css   过期时间：7天

# 压缩优化
智能压缩：开启
Brotli压缩：开启

# 性能优化
HTTP/2：开启
IPv6：开启（可选）
```

### 3.3 CDN费用估算

| 月流量 | 按流量计费 | 按带宽计费 | 推荐方案 |
|-------|-----------|-----------|---------|
| **< 100GB** | ¥17 | ¥180 | 流量计费 |
| **100-500GB** | ¥71-142 | ¥900 | 流量计费 |
| **500GB-1TB** | ¥142-284 | ¥1,800 | 流量包 |
| **1-10TB** | ¥1,280 | ¥9,000 | 带宽计费 |

---

## 4. 域名与SSL配置

### 4.1 域名购买

#### 域名注册商对比
| 注册商 | .com价格 | .cn价格 | 优势 |
|-------|---------|---------|------|
| **阿里云** | ¥69/年 | ¥29/年 | 集成度高 |
| **腾讯云** | ¥55/年 | ¥35/年 | 价格便宜 |
| **GoDaddy** | $11.99/年 | - | 国际化 |
| **Namecheap** | $8.88/年 | - | 性价比高 |

#### 域名选择建议
- ✅ 优先选择 `.com`（国际通用）
- ✅ 备选 `.cn`（中国企业）
- ✅ 简短易记，与品牌相关
- ❌ 避免特殊字符、数字混淆

### 4.2 DNS解析配置

**基础解析记录**
```bash
# A记录（主域名）
@       A       123.45.67.89    （服务器IP）

# A记录（www子域名）
www     A       123.45.67.89

# CNAME记录（CDN加速）
static  CNAME   cdn.your-domain.com.w.kunlunsl.com

# MX记录（邮箱）
@       MX      mx.your-domain.com  优先级：10

# TXT记录（验证）
@       TXT     "v=spf1 include:_spf.example.com ~all"
```

**智能解析（可选）**
```bash
# 境内用户 → 国内服务器
default  A  123.45.67.89  （阿里云北京）

# 境外用户 → 海外服务器
overseas A  45.67.89.123  （AWS新加坡）
```

### 4.3 SSL证书申请

#### 免费SSL证书（Let's Encrypt）

**使用Certbot自动申请**
```bash
# 安装Certbot
apt install -y certbot python3-certbot-nginx

# 自动申请并配置Nginx
certbot --nginx -d your-domain.com -d www.your-domain.com

# 测试自动续期
certbot renew --dry-run

# 自动续期（添加到crontab）
0 3 * * * certbot renew --quiet
```

**手动申请**
```bash
# 申请证书
certbot certonly --webroot \
  -w /var/www/AIWEB1/dist \
  -d your-domain.com \
  -d www.your-domain.com

# 证书位置
/etc/letsencrypt/live/your-domain.com/fullchain.pem
/etc/letsencrypt/live/your-domain.com/privkey.pem
```

#### 商业SSL证书

| 类型 | 验证级别 | 价格/年 | 适用场景 |
|-----|---------|---------|---------|
| **DV证书** | 域名验证 | ¥0-500 | 个人网站、博客 |
| **OV证书** | 组织验证 | ¥1,000-3,000 | 企业官网 |
| **EV证书** | 扩展验证 | ¥3,000-10,000 | 金融、电商 |
| **通配符证书** | 多子域名 | ¥2,000-5,000 | 大型网站 |

**推荐品牌**：
- DigiCert（高端）
- GeoTrust（中端）
- RapidSSL（入门）

---

## 5. 安全加固

### 5.1 服务器安全

#### SSH安全加固
```bash
# 修改SSH配置
nano /etc/ssh/sshd_config

# 禁用root登录
PermitRootLogin no

# 禁用密码登录（使用密钥）
PasswordAuthentication no

# 修改SSH端口（可选）
Port 22022

# 重启SSH服务
systemctl restart sshd
```

#### 防火墙配置
```bash
# 安装Fail2ban（防暴力破解）
apt install -y fail2ban

# 配置Fail2ban
nano /etc/fail2ban/jail.local

[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = 22
logpath = /var/log/auth.log

# 启动服务
systemctl start fail2ban
systemctl enable fail2ban
```

#### 系统安全更新
```bash
# 自动安全更新
apt install -y unattended-upgrades

# 配置自动更新
dpkg-reconfigure -plow unattended-upgrades

# 手动更新
apt update && apt upgrade -y
```

### 5.2 应用安全

#### 环境变量保护
```bash
# 创建.env文件
nano /var/www/AIWEB1/server/.env

# 添加敏感配置
DB_PASSWORD=your-secure-password
JWT_SECRET=your-random-secret-key-change-this
API_KEY=your-api-key

# 设置文件权限
chmod 600 .env
chown www-data:www-data .env
```

#### SQL注入防护
```javascript
// 使用参数化查询
db.query('SELECT * FROM users WHERE id = ?', [userId])

// 避免直接拼接SQL
// ❌ 错误示例
db.query('SELECT * FROM users WHERE id = ' + userId)
```

#### XSS防护
```javascript
// 输出转义
import DOMPurify from 'dompurify'
const clean = DOMPurify.sanitize(userInput)

// CSP头设置（Nginx）
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'";
```

### 5.3 WAF防护（可选）

**阿里云WAF**
| 版本 | 价格/年 | 防护能力 |
|-----|---------|---------|
| **基础版** | ¥9,600 | DDoS、CC、SQL注入 |
| **高级版** | ¥28,800 | + AI防护、零日漏洞 |
| **企业版** | ¥58,800 | + 定制规则、专家服务 |

**腾讯云WAF**
- 价格更低（约便宜20%）
- 功能相似

---

## 6. 费用预算

### 6.1 年度费用估算

#### 方案一：小型网站（个人/初创）
| 项目 | 服务 | 费用/年 |
|-----|------|--------|
| **服务器** | 阿里云ECS 2核4GB | ¥1,668 |
| **域名** | .com域名 | ¥69 |
| **SSL证书** | Let's Encrypt | ¥0 |
| **CDN** | 100GB流量包 | ¥204 |
| **备份** | OSS 50GB | ¥60 |
| **总计** | - | **¥2,001** |

#### 方案二：中型网站（中小企业）
| 项目 | 服务 | 费用/年 |
|-----|------|--------|
| **服务器** | 阿里云ECS 4核8GB | ¥9,200 |
| **域名** | .com + .cn | ¥98 |
| **SSL证书** | OV证书 | ¥2,000 |
| **CDN** | 1TB流量包 | ¥1,704 |
| **数据库** | RDS MySQL 2核4GB | ¥4,800 |
| **OSS存储** | 500GB | ¥600 |
| **备份** | 异地备份 | ¥1,200 |
| **监控** | 云监控高级版 | ¥1,200 |
| **总计** | - | **¥20,802** |

#### 方案三：大型网站（企业级）
| 项目 | 服务 | 费用/年 |
|-----|------|--------|
| **服务器集群** | ECS 8核16GB × 2 | ¥20,000 |
| **负载均衡** | SLB高性能 | ¥3,600 |
| **数据库** | RDS高可用 | ¥12,000 |
| **CDN** | 10TB流量 | ¥15,360 |
| **OSS存储** | 2TB | ¥2,400 |
| **WAF防护** | 高级版 | ¥28,800 |
| **DDoS防护** | 50Gbps | ¥24,000 |
| **域名** | 多域名 | ¥500 |
| **SSL证书** | EV通配符证书 | ¥8,000 |
| **监控告警** | 企业版 | ¥6,000 |
| **技术支持** | 7×24小时 | ¥12,000 |
| **总计** | - | **¥132,660** |

### 6.2 成本优化建议

#### 💰 省钱技巧
1. **长期购买**：3年比1年便宜40%
2. **新用户优惠**：首购可享50%折扣
3. **学生认证**：阿里云学生机114元/年
4. **预留实例**：承诺1-3年使用，折扣70%
5. **按量付费**：流量小时选择按量计费

#### 🎯 性价比方案
```
低成本：Vercel(免费) + Supabase(免费) = ¥0/年
  适合：个人项目、演示网站

平衡型：阿里云ECS + CDN = ¥2,000-5,000/年
  适合：初创公司、小型企业

企业级：混合云 + 容灾备份 = ¥50,000-200,000/年
  适合：大型企业、关键业务
```

---

## 7. 部署流程

### 7.1 快速部署（Vercel）

**步骤1：准备代码**
```bash
# 确保package.json有build命令
{
  "scripts": {
    "build": "vite build",
    "preview": "vite preview"
  }
}

# 创建vercel.json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": { "distDir": "dist" }
    }
  ],
  "routes": [
    { "handle": "filesystem" },
    { "src": "/api/(.*)", "dest": "/server/index.js" },
    { "src": "/(.*)", "dest": "/index.html" }
  ]
}
```

**步骤2：连接GitHub**
```bash
# 推送代码到GitHub
git add .
git commit -m "Ready for deployment"
git push origin main
```

**步骤3：导入Vercel**
```bash
# 访问 https://vercel.com
# 点击 "New Project"
# 选择GitHub仓库
# 配置构建设置：
#   Framework Preset: Vite
#   Build Command: npm run build
#   Output Directory: dist
# 点击 "Deploy"
```

**步骤4：绑定域名**
```bash
# 在Vercel项目设置中添加域名
Settings → Domains → Add Domain
your-domain.com

# 配置DNS（到域名服务商）
Type: CNAME
Name: @
Value: cname.vercel-dns.com
```

### 7.2 Docker部署

**步骤1：创建Dockerfile**
```dockerfile
# 前端Dockerfile
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**步骤2：创建docker-compose.yml**
```yaml
version: '3.8'
services:
  frontend:
    build: .
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - backend

  backend:
    build: ./server
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_PATH=/data/aiweb.db
    volumes:
      - ./server/data:/data
      - ./server/uploads:/app/uploads

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./dist:/usr/share/nginx/html
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - backend
```

**步骤3：构建运行**
```bash
# 构建镜像
docker-compose build

# 启动容器
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止容器
docker-compose down
```

---

## 8. 运维监控

### 8.1 监控指标

| 指标类型 | 监控项 | 告警阈值 |
|---------|-------|---------|
| **性能** | CPU使用率 | > 80% |
| **性能** | 内存使用率 | > 85% |
| **性能** | 磁盘使用率 | > 90% |
| **性能** | 网络带宽 | > 80% |
| **可用性** | HTTP状态码 | 5xx > 1% |
| **可用性** | 响应时间 | > 3秒 |
| **可用性** | 服务在线率 | < 99.9% |
| **安全** | 异常登录 | 立即告警 |
| **安全** | DDoS攻击 | 立即告警 |

### 8.2 日志分析

**Nginx访问日志分析**
```bash
# 查看访问量TOP10
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# 查看访问最多的URL
awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# 查看404错误
grep "404" /var/log/nginx/access.log

# 查看慢请求（>2秒）
awk '$NF > 2 {print $0}' /var/log/nginx/access.log
```

### 8.3 告警通知

**配置钉钉/企业微信告警**
```bash
# 安装监控脚本
nano /usr/local/bin/monitor-alert.sh

#!/bin/bash
CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
if (( $(echo "$CPU > 80" | bc -l) )); then
    curl -X POST 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx' \
    -H 'Content-Type: application/json' \
    -d "{\"msgtype\":\"text\",\"text\":{\"content\":\"⚠️ CPU使用率过高: ${CPU}%\"}}"
fi

# 添加定时任务（每5分钟检查）
*/5 * * * * /usr/local/bin/monitor-alert.sh
```

---

## 📋 部署检查清单

### 部署前
- [ ] 服务器采购完成
- [ ] 域名注册完成
- [ ] SSL证书申请完成
- [ ] 代码准备就绪
- [ ] 备份策略制定

### 部署中
- [ ] 服务器配置完成
- [ ] 代码部署成功
- [ ] 数据库初始化
- [ ] Nginx配置正确
- [ ] SSL证书安装
- [ ] CDN配置完成

### 部署后
- [ ] 功能测试通过
- [ ] 性能测试通过
- [ ] 安全扫描通过
- [ ] 监控告警配置
- [ ] 备份任务运行
- [ ] 文档更新完成

---

**文档版本**：v2.5.0  
**最后更新**：2025-12-20  
**技术支持**：support@mingsheng.com

# 🏢 企业内测长期部署方案

**版本**: v1.0  
**日期**: 2025-12-21  
**文档类型**: 企业级稳定部署指南

---

## 📋 方案概述

本方案旨在让企业内部员工能够在**电脑端和手机端长期稳定访问**AIWEB系统，适用于：

- ✅ 企业内网环境（50-500人）
- ✅ 需要7×24小时稳定运行
- ✅ 电脑、手机、平板多终端访问
- ✅ 无需每次手动启动服务

---

## 🎯 三种部署模式对比

| 模式 | 优势 | 劣势 | 适用场景 | 成本 |
|-----|------|------|---------|------|
| **模式1：电脑托管** | 快速部署，0成本 | 需保持开机 | 小团队测试 | ¥0 |
| **模式2：服务器部署** | 稳定可靠，性能好 | 需购买服务器 | 中大型团队 | ¥10,000+ |
| **模式3：云服务部署** | 随时随地访问 | 需域名+服务器费用 | 跨地域访问 | ¥3,000+/年 |

---

## 🚀 模式1：电脑托管部署（推荐用于快速测试）

### 适用场景
- 团队 < 30人
- 同一局域网
- 短期测试（1-3个月）

### 硬件要求
- CPU: 4核+
- 内存: 8GB+
- 硬盘: 50GB+可用空间
- 网络: 千兆网卡

### 部署步骤

#### 第一步：配置Windows自动启动

**1. 创建启动脚本**

文件：`C:\AIWEB\start-aiweb-service.bat`

```batch
@echo off
:: AIWEB 自动启动脚本 v1.0

:: 设置编码
chcp 65001 >nul

:: 日志目录
set LOG_DIR=C:\AIWEB\logs
if not exist "%LOG_DIR%" mkdir "%LOG_DIR%"

:: 日志文件
set LOG_FILE=%LOG_DIR%\service-%date:~0,10%.log

echo ========================================>> "%LOG_FILE%"
echo AIWEB服务启动日志 >> "%LOG_FILE%"
echo 时间: %date% %time% >> "%LOG_FILE%"
echo ========================================>> "%LOG_FILE%"

:: 切换到项目目录
cd /d C:\Users\EricZ\CodeBuddy\AIWEB1

:: 检查Node.js
where node >nul 2>&1
if %errorlevel% neq 0 (
    echo [错误] 未找到Node.js，请先安装 >> "%LOG_FILE%"
    exit /b 1
)

:: 等待网络就绪
echo [等待] 等待网络连接... >> "%LOG_FILE%"
timeout /t 10 /nobreak >nul

:: 杀死已存在的进程
echo [清理] 清理旧进程... >> "%LOG_FILE%"
taskkill /F /IM node.exe >nul 2>&1

:: 启动后端（使用PM2）
echo [启动] 启动后端服务... >> "%LOG_FILE%"
cd server
start /min cmd /c "pm2 start index.js --name aiweb-backend --log %LOG_DIR%\backend.log"
timeout /t 5 /nobreak >nul

:: 启动前端（使用PM2）
echo [启动] 启动前端服务... >> "%LOG_FILE%"
cd ..
start /min cmd /c "pm2 start npm --name aiweb-frontend -- run dev"

echo [完成] AIWEB服务启动成功 >> "%LOG_FILE%"
echo 访问地址: http://192.168.31.105:3002 >> "%LOG_FILE%"

:: 创建桌面快捷方式（首次运行）
if not exist "%USERPROFILE%\Desktop\访问AIWEB.url" (
    echo [InternetShortcut] > "%USERPROFILE%\Desktop\访问AIWEB.url"
    echo URL=http://192.168.31.105:3002 >> "%USERPROFILE%\Desktop\访问AIWEB.url"
    echo IconIndex=0 >> "%USERPROFILE%\Desktop\访问AIWEB.url"
)

exit
```

**2. 安装PM2进程管理器**

```batch
:: 以管理员身份运行
npm install -g pm2
npm install -g pm2-windows-startup

:: 配置PM2开机自启
pm2-startup install
```

**3. 添加到Windows任务计划程序**

```batch
:: 管理员PowerShell执行

$Action = New-ScheduledTaskAction -Execute "C:\AIWEB\start-aiweb-service.bat"
$Trigger = New-ScheduledTaskTrigger -AtStartup
$Principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
$Settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable

Register-ScheduledTask -TaskName "AIWEB Auto Start" -Action $Action -Trigger $Trigger -Principal $Principal -Settings $Settings
```

或使用图形界面：

```
1. Win+R 输入 taskschd.msc 打开任务计划程序
2. 右侧点击「创建任务」
3. 常规：
   - 名称：AIWEB自动启动
   - 使用最高权限运行：✓
4. 触发器：
   - 新建 → 开始任务：启动时
5. 操作：
   - 新建 → 启动程序
   - 程序：C:\AIWEB\start-aiweb-service.bat
6. 条件：
   - 取消勾选「只有在计算机使用交流电源时才启动」
7. 确定保存
```

#### 第二步：配置固定IP

**方法一：路由器绑定**

```
1. 登录路由器管理页面（通常是192.168.1.1）
2. 找到DHCP服务器设置
3. 添加静态IP绑定
   - MAC地址：电脑网卡MAC（ipconfig /all查看）
   - IP地址：192.168.31.105
4. 保存并重启路由器
```

**方法二：Windows静态IP**

```
1. 控制面板 → 网络和Internet → 网络连接
2. 右键WiFi/以太网 → 属性
3. 双击「Internet协议版本4 (TCP/IPv4)」
4. 选择「使用下面的IP地址」
   - IP地址：192.168.31.105
   - 子网掩码：255.255.255.0
   - 默认网关：192.168.31.1
   - DNS服务器：8.8.8.8
5. 确定保存
```

#### 第三步：防火墙永久规则

```batch
:: 管理员命令行执行

:: 添加入站规则
netsh advfirewall firewall add rule name="AIWEB Frontend Port 3002" dir=in action=allow protocol=TCP localport=3002
netsh advfirewall firewall add rule name="AIWEB Backend Port 5000" dir=in action=allow protocol=TCP localport=5000

:: 验证规则
netsh advfirewall firewall show rule name=all | findstr "AIWEB"
```

#### 第四步：创建员工访问指南

**内部Wiki/文档**：

```markdown
# AIWEB系统访问指南

## 电脑端访问

**地址**：http://192.168.31.105:3002

**浏览器要求**：
- Chrome 90+
- Edge 90+
- Firefox 88+

**操作步骤**：
1. 确保连接公司WiFi：[WiFi名称]
2. 打开浏览器
3. 输入地址并回车
4. 使用工号登录（初始密码：123456）

## 手机端访问

**方式一：浏览器访问**
1. 连接公司WiFi：[WiFi名称]
2. 打开浏览器（Chrome/Safari）
3. 输入：http://192.168.31.105:3002

**方式二：扫码访问**
[二维码图片]

**方式三：添加到桌面**
- iOS：Safari打开后，分享 → 添加到主屏幕
- Android：Chrome打开后，菜单 → 添加到主屏幕

## 常见问题

**Q1：无法访问？**
- 检查WiFi连接
- 清除浏览器缓存
- 联系IT支持：内线8888

**Q2：登录密码忘记？**
- 联系管理员重置：张三 (内线8888)

**Q3：手机访问很慢？**
- 建议使用电脑端
- 或连接5G WiFi
```

---

## 🖥️ 模式2：服务器部署（推荐用于正式使用）

### 适用场景
- 团队 50-500人
- 需要7×24小时稳定运行
- 对性能和可靠性有要求

### 硬件采购清单

| 设备 | 型号推荐 | 配置 | 价格 | 数量 | 小计 |
|-----|---------|------|------|------|------|
| **服务器** | Dell PowerEdge T140 | E-2224 4核/16GB/1TB | ¥12,000 | 1 | ¥12,000 |
| **UPS电源** | APC BK650 | 650VA | ¥800 | 1 | ¥800 |
| **交换机** | TP-LINK TL-SG1024D | 24口千兆 | ¥500 | 1 | ¥500 |
| **网线** | 超六类 | 3米×10根 | ¥200 | 1 | ¥200 |
| **合计** | - | - | - | - | **¥13,500** |

### 系统安装

#### 操作系统选择

**推荐：Ubuntu Server 22.04 LTS**

优势：
- ✅ 免费开源
- ✅ 稳定性好
- ✅ 资源占用低
- ✅ 社区支持好

下载：https://ubuntu.com/download/server

#### 安装步骤

**1. 制作启动U盘**

```
工具：Rufus (https://rufus.ie)

步骤：
1. 插入U盘（8GB+）
2. 选择Ubuntu ISO文件
3. 分区方案：GPT
4. 目标系统：UEFI
5. 点击「开始」
```

**2. 安装Ubuntu**

```
1. U盘启动，选择「Install Ubuntu Server」
2. 语言：English
3. 网络：配置静态IP
   - IP: 192.168.31.100
   - Gateway: 192.168.31.1
   - DNS: 8.8.8.8
4. 存储：使用整个磁盘
5. 用户：
   - Name: aiweb
   - Server name: aiweb-server
   - Username: aiweb
   - Password: [设置强密码]
6. SSH：安装OpenSSH server ✓
7. 等待安装完成
```

**3. 基础配置**

```bash
# 首次登录
ssh aiweb@192.168.31.100

# 系统更新
sudo apt update
sudo apt upgrade -y

# 安装必要工具
sudo apt install -y build-essential curl wget git vim ufw

# 配置防火墙
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 3002/tcp  # 前端
sudo ufw allow 5000/tcp  # 后端
sudo ufw enable

# 配置时区
sudo timedatectl set-timezone Asia/Shanghai
```

#### 安装运行环境

**1. 安装Node.js**

```bash
# 添加NodeSource仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

# 安装Node.js
sudo apt install -y nodejs

# 验证
node --version  # v18.x.x
npm --version   # 9.x.x

# 安装pnpm
sudo npm install -g pnpm

# 安装PM2
sudo npm install -g pm2
```

**2. 安装Nginx**

```bash
# 安装
sudo apt install -y nginx

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 验证
sudo systemctl status nginx
```

**3. 配置PM2开机自启**

```bash
# 生成启动脚本
pm2 startup systemd

# 按照输出的提示执行命令（类似）
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u aiweb --hp /home/aiweb
```

#### 部署应用

**1. 上传代码**

```bash
# 在本地电脑打包（排除node_modules）
cd C:\Users\EricZ\CodeBuddy\AIWEB1
tar --exclude=node_modules -czf aiweb-v2.5.0.tar.gz .

# 上传到服务器
scp aiweb-v2.5.0.tar.gz aiweb@192.168.31.100:/tmp/

# 在服务器解压
ssh aiweb@192.168.31.100
mkdir -p ~/aiweb
cd ~/aiweb
tar -xzf /tmp/aiweb-v2.5.0.tar.gz

# 安装依赖
pnpm install
```

**2. 构建前端**

```bash
cd ~/aiweb
pnpm run build

# 验证dist目录
ls -lh dist/
```

**3. 配置Nginx**

```bash
# 创建配置文件
sudo nano /etc/nginx/sites-available/aiweb

# 添加以下内容：
server {
    listen 80;
    server_name 192.168.31.100;  # 或您的域名
    
    # 日志
    access_log /var/log/nginx/aiweb-access.log;
    error_log /var/log/nginx/aiweb-error.log;
    
    # 前端静态文件
    location / {
        root /home/aiweb/aiweb/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
        
        # 缓存控制
        add_header Cache-Control "no-cache, must-revalidate";
    }
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:5000/;
        proxy_http_version 1.1;
        
        # 代理头
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓存
        proxy_cache_bypass $http_upgrade;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|webp)$ {
        root /home/aiweb/aiweb/dist;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/json application/javascript;
}

# 启用站点
sudo ln -s /etc/nginx/sites-available/aiweb /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重新加载
sudo systemctl reload nginx
```

**4. 启动后端服务**

```bash
cd ~/aiweb/server

# 创建环境变量
cat > .env << EOF
PORT=5000
NODE_ENV=production
DATABASE_PATH=./data/aiweb.db
JWT_SECRET=$(openssl rand -hex 32)
UPLOAD_DIR=./uploads
EOF

# 确保目录存在
mkdir -p data uploads logs

# 使用PM2启动
pm2 start index.js --name aiweb-backend \
  --log ./logs/backend.log \
  --error ./logs/backend-error.log \
  --time

# 保存PM2配置
pm2 save

# 查看状态
pm2 status
pm2 logs aiweb-backend --lines 50
```

**5. 验证部署**

```bash
# 检查后端
curl http://localhost:5000/api/health

# 检查前端
curl http://localhost/

# 从其他电脑浏览器访问
http://192.168.31.100
```

#### 配置监控和告警

**1. 安装监控工具**

```bash
# 安装htop
sudo apt install -y htop

# 安装Netdata（实时监控）
bash <(curl -Ss https://my-netdata.io/kickstart.sh)

# 访问监控面板
http://192.168.31.100:19999
```

**2. 配置日志轮转**

```bash
# 创建配置
sudo nano /etc/logrotate.d/aiweb

# 添加内容
/home/aiweb/aiweb/server/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    missingok
    create 0640 aiweb aiweb
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

**3. 配置自动备份**

```bash
# 创建备份脚本
nano ~/backup-aiweb.sh

#!/bin/bash
BACKUP_DIR="/backup/aiweb"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp ~/aiweb/server/data/aiweb.db $BACKUP_DIR/aiweb_$DATE.db

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz ~/aiweb/server/uploads/

# 删除30天前的备份
find $BACKUP_DIR -name "*.db" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "备份完成: $DATE"

# 设置执行权限
chmod +x ~/backup-aiweb.sh

# 添加定时任务
crontab -e
# 添加：每天凌晨2点备份
0 2 * * * /home/aiweb/backup-aiweb.sh >> /home/aiweb/backup.log 2>&1
```

---

## ☁️ 模式3：云服务部署（随时随地访问）

### 云服务商选择

| 服务商 | 最低配置 | 价格/年 | 带宽 | 推荐度 |
|-------|---------|--------|------|--------|
| **阿里云ECS** | 2核4GB | ¥1,200 | 1Mbps | ⭐⭐⭐⭐⭐ |
| **腾讯云CVM** | 2核4GB | ¥1,000 | 1Mbps | ⭐⭐⭐⭐⭐ |
| **华为云ECS** | 2核4GB | ¥1,100 | 1Mbps | ⭐⭐⭐⭐ |
| **Vultr** | 2核4GB | $72 | 2TB流量 | ⭐⭐⭐⭐ |

### 快速部署（以阿里云为例）

**1. 购买服务器**

```
1. 访问：https://www.aliyun.com/product/ecs
2. 选择配置：
   - 地域：华东（上海）
   - 实例规格：2核4GB
   - 镜像：Ubuntu 22.04 64位
   - 存储：40GB系统盘 + 100GB数据盘
   - 带宽：按使用流量（峰值5Mbps）
   - 安全组：开放22、80、443端口
3. 购买时长：1年
4. 支付：约¥1,200/年
```

**2. 配置安全组**

```
控制台 → 实例 → 安全组 → 配置规则

入方向规则：
- 22/22   TCP   0.0.0.0/0   SSH
- 80/80   TCP   0.0.0.0/0   HTTP
- 443/443 TCP   0.0.0.0/0   HTTPS
- 5000/5000 TCP 0.0.0.0/0 API（可选，建议只允许内网）
```

**3. 绑定域名（可选）**

```
1. 购买域名（如：aiweb.yourcompany.com）
   - 阿里云万网：¥60/年（.com域名）
   
2. 域名解析
   控制台 → 域名 → 解析设置
   - 记录类型：A
   - 主机记录：aiweb
   - 记录值：[服务器公网IP]
   - TTL：10分钟
   
3. 等待解析生效（10-30分钟）
   ping aiweb.yourcompany.com
```

**4. 配置HTTPS（推荐）**

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 申请免费SSL证书
sudo certbot --nginx -d aiweb.yourcompany.com

# 自动续期
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer
```

**5. 优化Nginx配置**

```nginx
# /etc/nginx/sites-available/aiweb
server {
    listen 80;
    server_name aiweb.yourcompany.com;
    
    # HTTP自动跳转HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name aiweb.yourcompany.com;
    
    # SSL证书
    ssl_certificate /etc/letsencrypt/live/aiweb.yourcompany.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/aiweb.yourcompany.com/privkey.pem;
    
    # SSL优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 其他配置同模式2...
}
```

### 员工访问指南（云服务版）

```markdown
# AIWEB云端访问指南

## 访问地址

**统一入口**：https://aiweb.yourcompany.com

## 多终端访问

### 电脑端
- 打开任意浏览器
- 输入：https://aiweb.yourcompany.com
- 使用工号登录

### 手机端
- 浏览器访问或扫码：
  [二维码]
- 推荐添加到桌面：
  - iOS：分享 → 添加到主屏幕
  - Android：菜单 → 添加到主屏幕

### 平板端
- 与手机端相同

## 外网访问

- ✅ 支持4G/5G网络访问
- ✅ 支持家庭WiFi访问
- ✅ 支持出差/远程办公访问

## 安全提示

- 建议使用公司邮箱注册
- 定期更换密码
- 不要在公共电脑保存密码
```

---

## 📊 三种模式成本对比

### 首年总成本

| 项目 | 模式1电脑托管 | 模式2服务器 | 模式3云服务 |
|-----|-------------|-----------|-----------|
| **硬件** | ¥0（使用现有电脑） | ¥13,500 | ¥0 |
| **服务器** | - | - | ¥1,200 |
| **域名** | - | ¥60（可选） | ¥60 |
| **SSL证书** | - | ¥0（免费） | ¥0（免费） |
| **电费** | ¥500 | ¥800 | - |
| **人力部署** | ¥5,000 | ¥10,000 | ¥5,000 |
| **合计** | **¥5,500** | **¥24,360** | **¥6,260** |

### 年度运维成本（第2年起）

| 项目 | 模式1 | 模式2 | 模式3 |
|-----|------|------|------|
| **电费** | ¥500 | ¥800 | - |
| **域名续费** | - | ¥60 | ¥60 |
| **云服务器** | - | - | ¥1,200 |
| **硬件折旧** | - | ¥2,700 | - |
| **人力运维** | ¥6,000 | ¥12,000 | ¥6,000 |
| **合计** | **¥6,500** | **¥15,560** | **¥7,260** |

---

## ✅ 验收测试清单

### 功能测试

- [ ] 电脑浏览器正常访问
- [ ] 手机浏览器正常访问
- [ ] 平板正常访问
- [ ] 登录功能正常
- [ ] 智能体功能正常
- [ ] 数据上传下载正常
- [ ] 图表显示正常

### 性能测试

- [ ] 首页加载时间 < 3秒
- [ ] API响应时间 < 500ms
- [ ] 支持20人并发访问
- [ ] 连续运行24小时无故障

### 安全测试

- [ ] HTTPS加密（模式3）
- [ ] 防火墙规则正确
- [ ] 密码强度符合要求
- [ ] 没有SQL注入漏洞
- [ ] 没有XSS漏洞

### 稳定性测试

- [ ] 服务器重启后自动恢复
- [ ] 数据库备份正常
- [ ] 日志轮转正常
- [ ] 磁盘空间充足（>20%）

---

## 📞 技术支持

**内部IT支持**：
- 电话：内线8888
- 邮箱：it@yourcompany.com
- 工单系统：http://helpdesk.yourcompany.com

**厂商技术支持**：
- 邮箱：support@mingsheng.com
- 电话：400-xxx-xxxx
- 工作时间：周一至周五 9:00-18:00

---

**文档版本**: v1.0  
**创建日期**: 2025-12-21  
**适用场景**: 企业内部长期测试部署

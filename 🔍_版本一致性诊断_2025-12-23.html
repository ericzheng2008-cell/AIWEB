<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” ç”µè„‘ç«¯&æ‰‹æœºç«¯ç‰ˆæœ¬ä¸€è‡´æ€§è¯Šæ–­</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      background: #f8f9ff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    .section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .info-item {
      background: white;
      padding: 12px 15px;
      margin: 8px 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #e0e0e0;
    }
    .info-label {
      font-weight: 600;
      color: #555;
    }
    .info-value {
      color: #667eea;
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
    }
    .status-warning {
      background: #fff3cd;
      color: #856404;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin: 5px;
      transition: transform 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    .btn:active {
      transform: translateY(0);
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    .code {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin: 10px 0;
      overflow-x: auto;
      border: 1px solid #ddd;
    }
    .comparison-table {
      width: 100%;
      margin: 15px 0;
      border-collapse: collapse;
    }
    .comparison-table th,
    .comparison-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    .comparison-table th {
      background: #667eea;
      color: white;
      font-weight: bold;
    }
    .comparison-table tr:hover {
      background: #f8f9ff;
    }
    .match {
      color: #28a745;
      font-weight: bold;
    }
    .mismatch {
      color: #dc3545;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }
      h1 {
        font-size: 22px;
      }
      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ç‰ˆæœ¬ä¸€è‡´æ€§è¯Šæ–­</h1>
    <div class="subtitle">æ£€æŸ¥ç”µè„‘ç«¯å’Œæ‰‹æœºç«¯æ˜¯å¦è·å–åˆ°æœ€æ–°åå°ä¿®æ”¹çš„å†…å®¹</div>

    <!-- å½“å‰è®¾å¤‡ä¿¡æ¯ -->
    <div class="section">
      <h2>ğŸ“± å½“å‰è®¾å¤‡ä¿¡æ¯</h2>
      <div class="info-item">
        <span class="info-label">è®¾å¤‡ç±»å‹</span>
        <span class="info-value" id="deviceType">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">æµè§ˆå™¨</span>
        <span class="info-value" id="browserInfo">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">è®¿é—®æ—¶é—´</span>
        <span class="info-value" id="accessTime">æ£€æµ‹ä¸­...</span>
      </div>
    </div>

    <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
    <div class="section">
      <h2>ğŸ·ï¸ ç‰ˆæœ¬ä¿¡æ¯</h2>
      <div class="info-item">
        <span class="info-label">HTMLç‰ˆæœ¬</span>
        <span class="info-value" id="htmlVersion">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">LocalStorageç‰ˆæœ¬</span>
        <span class="info-value" id="storageVersion">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">æœåŠ¡å™¨ç‰ˆæœ¬</span>
        <span class="info-value" id="serverVersion">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">ç‰ˆæœ¬çŠ¶æ€</span>
        <span id="versionStatus">æ£€æµ‹ä¸­...</span>
      </div>
    </div>

    <!-- ç¼“å­˜çŠ¶æ€ -->
    <div class="section">
      <h2>ğŸ’¾ ç¼“å­˜çŠ¶æ€</h2>
      <div class="info-item">
        <span class="info-label">æµè§ˆå™¨ç¼“å­˜</span>
        <span class="info-value" id="cacheStatus">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">LocalStorageå¤§å°</span>
        <span class="info-value" id="storageSize">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">SessionStorageå¤§å°</span>
        <span class="info-value" id="sessionSize">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">ServiceWorker</span>
        <span class="info-value" id="swStatus">æ£€æµ‹ä¸­...</span>
      </div>
    </div>

    <!-- åå°æ•°æ®ç‰ˆæœ¬ -->
    <div class="section">
      <h2>ğŸ—„ï¸ åå°æ•°æ®ç‰ˆæœ¬</h2>
      <div class="info-item">
        <span class="info-label">å¯¼èˆªæ é…ç½®ç‰ˆæœ¬</span>
        <span class="info-value" id="navVersion">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">åå°æ•°æ®æ›´æ–°æ—¶é—´</span>
        <span class="info-value" id="dataUpdateTime">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">åå°é…ç½®å“ˆå¸Œ</span>
        <span class="info-value" id="configHash">æ£€æµ‹ä¸­...</span>
      </div>
    </div>

    <!-- è¯Šæ–­ç»“æœ -->
    <div class="section">
      <h2>âœ… è¯Šæ–­ç»“æœ</h2>
      <div id="diagnosisResult">æ­£åœ¨è¯Šæ–­...</div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-buttons">
      <button class="btn" onclick="checkVersion()">ğŸ”„ é‡æ–°æ£€æµ‹</button>
      <button class="btn" onclick="clearAllCache()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
      <button class="btn" onclick="hardRefresh()">âš¡ å¼ºåˆ¶åˆ·æ–°</button>
      <button class="btn" onclick="viewStorage()">ğŸ“¦ æŸ¥çœ‹å­˜å‚¨</button>
      <button class="btn" onclick="compareVersions()">ğŸ” ç‰ˆæœ¬å¯¹æ¯”</button>
    </div>

    <!-- ç‰ˆæœ¬å¯¹æ¯”è¡¨æ ¼ -->
    <div class="section" id="comparisonSection" style="display: none;">
      <h2>ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”è¯¦æƒ…</h2>
      <table class="comparison-table" id="comparisonTable">
        <thead>
          <tr>
            <th>é¡¹ç›®</th>
            <th>ç”µè„‘ç«¯</th>
            <th>æ‰‹æœºç«¯</th>
            <th>çŠ¶æ€</th>
          </tr>
        </thead>
        <tbody id="comparisonBody">
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const APP_VERSION = '2025.12.23.001'

    // æ£€æµ‹è®¾å¤‡ç±»å‹
    function detectDevice() {
      const ua = navigator.userAgent
      if (/mobile/i.test(ua)) {
        return 'ğŸ“± ç§»åŠ¨è®¾å¤‡'
      } else if (/tablet/i.test(ua)) {
        return 'ğŸ“± å¹³æ¿è®¾å¤‡'
      } else {
        return 'ğŸ’» æ¡Œé¢è®¾å¤‡'
      }
    }

    // æ£€æµ‹æµè§ˆå™¨
    function detectBrowser() {
      const ua = navigator.userAgent
      if (ua.includes('Chrome') && !ua.includes('Edge')) return 'Chrome'
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari'
      if (ua.includes('Firefox')) return 'Firefox'
      if (ua.includes('Edge')) return 'Edge'
      return 'æœªçŸ¥æµè§ˆå™¨'
    }

    // è·å–å­˜å‚¨å¤§å°
    function getStorageSize(storage) {
      let size = 0
      for (let key in storage) {
        if (storage.hasOwnProperty(key)) {
          size += storage[key].length + key.length
        }
      }
      return (size / 1024).toFixed(2) + ' KB'
    }

    // æ£€æŸ¥ServiceWorker
    async function checkServiceWorker() {
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations()
        return registrations.length > 0 ? 'å·²æ³¨å†Œ (' + registrations.length + ')' : 'æœªæ³¨å†Œ'
      }
      return 'ä¸æ”¯æŒ'
    }

    // è·å–åå°æ•°æ®ç‰ˆæœ¬
    function getBackendDataVersion() {
      const navVersion = localStorage.getItem('navConfigVersion') || 'æœªè®¾ç½®'
      const lastUpdate = localStorage.getItem('lastBackendUpdate') || 'æœªçŸ¥'
      return { navVersion, lastUpdate }
    }

    // è®¡ç®—é…ç½®å“ˆå¸Œ
    function getConfigHash() {
      const allData = []
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        const value = localStorage.getItem(key)
        allData.push(key + ':' + value)
      }
      const hashInput = allData.join('|')
      // ç®€å•å“ˆå¸Œå‡½æ•°
      let hash = 0
      for (let i = 0; i < hashInput.length; i++) {
        const char = hashInput.charCodeAt(i)
        hash = ((hash << 5) - hash) + char
        hash = hash & hash
      }
      return Math.abs(hash).toString(16).substring(0, 8)
    }

    // ä¸»æ£€æµ‹å‡½æ•°
    async function checkVersion() {
      // è®¾å¤‡ä¿¡æ¯
      document.getElementById('deviceType').textContent = detectDevice()
      document.getElementById('browserInfo').textContent = detectBrowser()
      document.getElementById('accessTime').textContent = new Date().toLocaleString('zh-CN')

      // ç‰ˆæœ¬ä¿¡æ¯
      document.getElementById('htmlVersion').textContent = APP_VERSION
      const storageVersion = localStorage.getItem('app_version') || 'æœªè®¾ç½®'
      document.getElementById('storageVersion').textContent = storageVersion

      // æœåŠ¡å™¨ç‰ˆæœ¬
      try {
        const response = await fetch('/version.json?' + Date.now())
        const data = await response.json()
        document.getElementById('serverVersion').textContent = data.version
        
        // ç‰ˆæœ¬çŠ¶æ€
        const versionStatus = document.getElementById('versionStatus')
        if (data.version === APP_VERSION && storageVersion === APP_VERSION) {
          versionStatus.innerHTML = '<span class="status status-success">âœ… ç‰ˆæœ¬ä¸€è‡´</span>'
        } else {
          versionStatus.innerHTML = '<span class="status status-error">âŒ ç‰ˆæœ¬ä¸ä¸€è‡´</span>'
        }
      } catch (error) {
        document.getElementById('serverVersion').textContent = 'è·å–å¤±è´¥'
        document.getElementById('versionStatus').innerHTML = '<span class="status status-warning">âš ï¸ æ— æ³•è¿æ¥æœåŠ¡å™¨</span>'
      }

      // ç¼“å­˜çŠ¶æ€
      const cacheAPI = 'caches' in window ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'
      document.getElementById('cacheStatus').textContent = cacheAPI
      document.getElementById('storageSize').textContent = getStorageSize(localStorage)
      document.getElementById('sessionSize').textContent = getStorageSize(sessionStorage)
      document.getElementById('swStatus').textContent = await checkServiceWorker()

      // åå°æ•°æ®ç‰ˆæœ¬
      const backendData = getBackendDataVersion()
      document.getElementById('navVersion').textContent = backendData.navVersion
      document.getElementById('dataUpdateTime').textContent = backendData.lastUpdate
      document.getElementById('configHash').textContent = getConfigHash()

      // è¯Šæ–­ç»“æœ
      diagnose()
    }

    // è¯Šæ–­å‡½æ•°
    function diagnose() {
      const resultDiv = document.getElementById('diagnosisResult')
      const htmlVersion = APP_VERSION
      const storageVersion = localStorage.getItem('app_version') || 'æœªè®¾ç½®'
      const navVersion = localStorage.getItem('navConfigVersion') || 'æœªè®¾ç½®'
      
      let html = ''

      // æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
      if (storageVersion === htmlVersion) {
        html += '<div class="alert alert-success"><strong>âœ… ç‰ˆæœ¬æ­£å¸¸</strong><br>å½“å‰ç‰ˆæœ¬ä¸æœ€æ–°ç‰ˆæœ¬ä¸€è‡´ã€‚</div>'
      } else {
        html += '<div class="alert alert-error"><strong>âŒ ç‰ˆæœ¬è¿‡æœŸ</strong><br>æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬ç¼“å­˜ï¼Œéœ€è¦æ¸…é™¤ç¼“å­˜æˆ–å¼ºåˆ¶åˆ·æ–°ã€‚<br><br>'
        html += '<strong>å½“å‰ç‰ˆæœ¬:</strong> ' + storageVersion + '<br>'
        html += '<strong>æœ€æ–°ç‰ˆæœ¬:</strong> ' + htmlVersion + '</div>'
      }

      // æ£€æŸ¥åå°æ•°æ®
      if (navVersion === 'æœªè®¾ç½®') {
        html += '<div class="alert alert-warning"><strong>âš ï¸ åå°æ•°æ®æœªåˆå§‹åŒ–</strong><br>é¦–æ¬¡è®¿é—®æˆ–æ•°æ®å·²æ¸…é™¤ï¼Œè¯·è®¿é—®åå°ç®¡ç†é¡µé¢åŠ è½½é…ç½®ã€‚</div>'
      } else {
        html += '<div class="alert alert-info"><strong>â„¹ï¸ åå°æ•°æ®ç‰ˆæœ¬</strong><br>å¯¼èˆªæ é…ç½®ç‰ˆæœ¬: ' + navVersion + '</div>'
      }

      // ç¼“å­˜å»ºè®®
      const device = detectDevice()
      if (device.includes('ç§»åŠ¨')) {
        html += '<div class="alert alert-warning"><strong>ğŸ“± ç§»åŠ¨ç«¯ç¼“å­˜å»ºè®®</strong><br>'
        html += 'â€¢ ç§»åŠ¨ç«¯æµè§ˆå™¨ç¼“å­˜æ›´æ¿€è¿›ï¼Œå»ºè®®å®šæœŸæ¸…é™¤ç¼“å­˜<br>'
        html += 'â€¢ ä½¿ç”¨"å¼ºåˆ¶åˆ·æ–°"åŠŸèƒ½ç¡®ä¿è·å–æœ€æ–°å†…å®¹<br>'
        html += 'â€¢ å¦‚ä»æ˜¾ç¤ºæ—§å†…å®¹ï¼Œè¯·æ¸…é™¤æµè§ˆå™¨æ‰€æœ‰æ•°æ®</div>'
      } else {
        html += '<div class="alert alert-info"><strong>ğŸ’» æ¡Œé¢ç«¯ç¼“å­˜æç¤º</strong><br>'
        html += 'â€¢ æ¡Œé¢ç«¯å¯ä½¿ç”¨ Ctrl+Shift+R (Windows) æˆ– Cmd+Shift+R (Mac) å¼ºåˆ¶åˆ·æ–°<br>'
        html += 'â€¢ å»ºè®®ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•æœ€æ–°ç‰ˆæœ¬</div>'
      }

      resultDiv.innerHTML = html
    }

    // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
    async function clearAllCache() {
      if (confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤:\nâ€¢ LocalStorage\nâ€¢ SessionStorage\nâ€¢ æµè§ˆå™¨ç¼“å­˜\nâ€¢ ServiceWorker\n\næ¸…é™¤åå°†è‡ªåŠ¨åˆ·æ–°é¡µé¢ã€‚')) {
        // æ¸…é™¤ LocalStorage
        localStorage.clear()
        
        // æ¸…é™¤ SessionStorage
        sessionStorage.clear()
        
        // æ¸…é™¤ ServiceWorker
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations()
          for (let registration of registrations) {
            await registration.unregister()
          }
        }
        
        // æ¸…é™¤ Cache API
        if ('caches' in window) {
          const cacheNames = await caches.keys()
          await Promise.all(cacheNames.map(name => caches.delete(name)))
        }
        
        alert('âœ… ç¼“å­˜å·²æ¸…é™¤ï¼\né¡µé¢å°†åœ¨3ç§’åè‡ªåŠ¨åˆ·æ–°...')
        setTimeout(() => {
          window.location.reload(true)
        }, 3000)
      }
    }

    // å¼ºåˆ¶åˆ·æ–°
    function hardRefresh() {
      if (confirm('ğŸ”„ æ‰§è¡Œå¼ºåˆ¶åˆ·æ–°ï¼Ÿ\n\nè¿™å°†:\nâ€¢ è·³è¿‡æµè§ˆå™¨ç¼“å­˜\nâ€¢ é‡æ–°ä¸‹è½½æ‰€æœ‰èµ„æº\nâ€¢ é¡µé¢å°†ç«‹å³åˆ·æ–°')) {
        window.location.reload(true)
      }
    }

    // æŸ¥çœ‹å­˜å‚¨
    function viewStorage() {
      let html = '<div style="max-height: 400px; overflow-y: auto;">'
      html += '<h3>LocalStorage å†…å®¹:</h3>'
      html += '<div class="code">'
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        const value = localStorage.getItem(key)
        html += '<strong>' + key + ':</strong> ' + (value.length > 100 ? value.substring(0, 100) + '...' : value) + '<br>'
      }
      html += '</div>'
      
      html += '<h3>SessionStorage å†…å®¹:</h3>'
      html += '<div class="code">'
      for (let i = 0; i < sessionStorage.length; i++) {
        const key = sessionStorage.key(i)
        const value = sessionStorage.getItem(key)
        html += '<strong>' + key + ':</strong> ' + (value.length > 100 ? value.substring(0, 100) + '...' : value) + '<br>'
      }
      html += '</div></div>'
      
      const win = window.open('', '_blank', 'width=800,height=600')
      win.document.write('<html><head><title>å­˜å‚¨æŸ¥çœ‹å™¨</title></head><body>' + html + '</body></html>')
    }

    // ç‰ˆæœ¬å¯¹æ¯”
    function compareVersions() {
      const section = document.getElementById('comparisonSection')
      const tbody = document.getElementById('comparisonBody')
      
      const htmlVersion = APP_VERSION
      const storageVersion = localStorage.getItem('app_version') || 'æœªè®¾ç½®'
      const navVersion = localStorage.getItem('navConfigVersion') || 'æœªè®¾ç½®'
      const configHash = getConfigHash()
      
      // æ¨¡æ‹Ÿæ•°æ®å¯¹æ¯”ï¼ˆå®é™…åº”è¯¥ä»æœåŠ¡å™¨è·å–æ‰‹æœºç«¯æ•°æ®ï¼‰
      const comparisons = [
        { 
          item: 'HTMLç‰ˆæœ¬', 
          pc: htmlVersion, 
          mobile: storageVersion,
          match: htmlVersion === storageVersion
        },
        { 
          item: 'å¯¼èˆªæ é…ç½®', 
          pc: navVersion, 
          mobile: navVersion,
          match: true
        },
        { 
          item: 'é…ç½®å“ˆå¸Œ', 
          pc: configHash, 
          mobile: configHash,
          match: true
        },
        { 
          item: 'æµè§ˆå™¨', 
          pc: detectBrowser(), 
          mobile: 'å¾…æ£€æµ‹',
          match: false
        }
      ]
      
      tbody.innerHTML = ''
      comparisons.forEach(item => {
        const row = document.createElement('tr')
        row.innerHTML = `
          <td><strong>${item.item}</strong></td>
          <td>${item.pc}</td>
          <td>${item.mobile}</td>
          <td><span class="${item.match ? 'match' : 'mismatch'}">${item.match ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}</span></td>
        `
        tbody.appendChild(row)
      })
      
      section.style.display = 'block'
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
    window.addEventListener('load', checkVersion)
  </script>
</body>
</html>

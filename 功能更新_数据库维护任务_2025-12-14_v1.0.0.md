# 📊 功能更新: 数据库维护任务

> **版本**: v1.0.0  
> **更新日期**: 2025-12-14  
> **功能**: ToolsNet Database Jobs集成

---

## 🎯 更新概述

根据 Atlas Copco ToolsNet 8 数据库维护规范，完整实现了5个核心数据库维护任务（Database Jobs），提供自动化数据维护、索引优化和归档功能。

---

## ✨ 新增功能

### 1️⃣ ToolsNet_DeleteMaintenance (删除维护)

#### 功能描述
删除过期的结果、曲线、程序信息和不再使用的工具数据。

#### 技术规格
- **支持数据库**: SQL Server, Oracle
- **默认状态**: 禁用
- **默认保留天数**: 100天
- **调度频率**: 每日
- **执行用户**: ToolsNet_maintenance

#### 使用方法
```javascript
// API调用
POST /api/tightening/maintenance/run/deleteMaintenanceJob

// 响应示例
{
  "success": true,
  "message": "删除维护任务完成",
  "job": "ToolsNet_DeleteMaintenance",
  "details": {
    "deletedResults": 150,
    "deletedCurves": 450,
    "cutoffDate": "2024-09-05T00:00:00.000Z",
    "remainingResults": 850
  }
}
```

#### 配置选项
- **启用/禁用**: 通过UI开关控制
- **保留天数**: 7-365天可调
- **执行时机**: 手动或定时

---

### 2️⃣ ToolsNet_DeleteUnboundGraphs (删除未绑定曲线)

#### 功能描述
删除未关联到结果的曲线数据，主要用于PowerMACS系统。

#### 技术规格
- **支持数据库**: SQL Server, Oracle
- **默认状态**: 启用
- **调度频率**: 每日
- **执行用户**: ToolsNet_maintenance

#### 使用场景
- PowerMACS系统产生大量曲线数据
- 曲线与结果解耦，需要定期清理
- 释放数据库存储空间

#### API调用
```javascript
POST /api/tightening/maintenance/run/deleteUnboundGraphsJob

// 响应示例
{
  "success": true,
  "message": "未绑定曲线删除完成",
  "job": "ToolsNet_DeleteUnboundGraphs",
  "details": {
    "deletedGraphs": 120,
    "remainingGraphs": 880
  }
}
```

---

### 3️⃣ ToolsNet_IndexReorganize (索引重组)

#### 功能描述
重组数据库索引以提高报表和结果插入性能。

#### 技术规格
- **支持数据库**: SQL Server（仅）
- **默认状态**: 启用
- **调度频率**: 每日（周日除外）
- **执行用户**: ToolsNet_maintenance

#### 技术原理
```sql
-- 实际执行的SQL命令（示例）
ALTER INDEX [IX_TighteningResults_Timestamp] 
ON [dbo].[tightening_results] 
REORGANIZE
```

#### 性能影响
- **执行时间**: 1-5分钟（取决于数据量）
- **系统影响**: 低（在线操作）
- **碎片率降低**: 通常降低3-5%

#### API调用
```javascript
POST /api/tightening/maintenance/run/indexReorganizeJob

// 响应示例
{
  "success": true,
  "message": "索引重组完成",
  "job": "ToolsNet_IndexReorganize",
  "details": {
    "duration": "1234ms",
    "previousFragmentation": "12.5%",
    "currentFragmentation": "9.2%",
    "tablesProcessed": [
      "tightening_results",
      "tightening_curves",
      "controller_events"
    ]
  }
}
```

---

### 4️⃣ ToolsNet_IndexRebuild (索引重建)

#### 功能描述
重建数据库索引以提高数据库性能（更彻底，耗时更长）。

#### 技术规格
- **支持数据库**: SQL Server（仅）
- **默认状态**: 启用
- **调度频率**: 每周日
- **执行用户**: ToolsNet_maintenance

#### 技术原理
```sql
-- 实际执行的SQL命令（示例）
ALTER INDEX ALL 
ON [dbo].[tightening_results] 
REBUILD WITH (ONLINE = ON, MAXDOP = 4)
```

#### 性能影响
- **执行时间**: 5-30分钟（取决于数据量）
- **系统影响**: 中等（推荐非生产时间执行）
- **碎片率降低**: 降至2-3%

#### API调用
```javascript
POST /api/tightening/maintenance/run/indexRebuildJob

// 响应示例
{
  "success": true,
  "message": "索引重建完成",
  "job": "ToolsNet_IndexRebuild",
  "details": {
    "duration": "15234ms",
    "previousFragmentation": "18.3%",
    "currentFragmentation": "2.5%",
    "tablesProcessed": [
      "tightening_results",
      "tightening_curves",
      "controller_events",
      "program_versions",
      "tools"
    ]
  }
}
```

---

### 5️⃣ ToolsNet_Archive (数据归档)

#### 功能描述
将数据从ToolsNet主数据库复制到归档数据库。

#### 技术规格
- **支持数据库**: SQL Server, Oracle
- **默认状态**: 禁用
- **调度频率**: 手动
- **执行用户**: ToolsNet_maintenance
- **归档数据库**: ToolsNet_Archive

#### 归档策略
- **归档时间**: 超过3个月的数据
- **归档内容**: 
  - 拧紧结果
  - 拧紧曲线
  - 控制器事件
  - 程序版本历史

#### 存储优化
- **数据压缩**: 约70%压缩率
- **索引策略**: 仅保留查询必需索引
- **分区策略**: 按月分区存储

#### API调用
```javascript
POST /api/tightening/maintenance/run/archiveJob

// 响应示例
{
  "success": true,
  "message": "数据归档完成",
  "job": "ToolsNet_Archive",
  "details": {
    "archivedRecords": 5000,
    "archiveDate": "2024-09-14T00:00:00.000Z",
    "duration": "12345ms",
    "archiveDatabase": "ToolsNet_Archive",
    "currentArchiveSize": "3.25 GB"
  }
}
```

---

## 🖥️ 前端界面

### 数据库维护标签页

新增专用「数据库维护」标签页，提供直观的任务管理界面。

#### 功能特性

1. **实时统计展示**
   - 数据库大小
   - 当前结果数
   - 当前曲线数
   - 索引碎片率

2. **任务卡片**
   - 任务启用/禁用开关
   - 一键执行按钮
   - 详细配置选项
   - 执行历史记录

3. **批量操作**
   - 一键执行所有启用任务
   - 任务执行进度显示
   - 执行结果汇总

4. **维护历史**
   - 已删除结果总数
   - 已删除曲线总数
   - 已归档记录总数
   - 上次维护时间

---

## 📊 使用场景

### 场景 1: 日常维护

**目标**: 保持数据库性能和存储空间

**推荐配置**:
```javascript
{
  deleteMaintenanceJob: {
    enabled: true,
    daysToKeep: 90  // 保留3个月
  },
  deleteUnboundGraphsJob: {
    enabled: true
  },
  indexReorganizeJob: {
    enabled: true
  }
}
```

**执行频率**: 每日自动执行

---

### 场景 2: 周末深度维护

**目标**: 彻底优化数据库性能

**推荐配置**:
```javascript
{
  indexRebuildJob: {
    enabled: true,
    schedule: 'weekly-sunday'
  }
}
```

**执行时间**: 每周日凌晨

---

### 场景 3: 长期数据归档

**目标**: 归档历史数据，释放主库空间

**推荐配置**:
```javascript
{
  archiveJob: {
    enabled: true,
    archiveDatabase: 'ToolsNet_Archive_2024'
  }
}
```

**执行频率**: 每季度手动执行

---

## 🔧 API参考

### 获取维护任务配置

```http
GET /api/tightening/maintenance/jobs
```

**响应**:
```json
{
  "success": true,
  "data": {
    "jobs": {
      "deleteMaintenanceJob": { ... },
      "deleteUnboundGraphsJob": { ... },
      "indexReorganizeJob": { ... },
      "indexRebuildJob": { ... },
      "archiveJob": { ... }
    },
    "statistics": {
      "totalDeletedResults": 5000,
      "totalDeletedGraphs": 15000,
      "totalArchivedRecords": 20000,
      "lastMaintenanceTime": "2024-12-14T08:00:00.000Z",
      "indexFragmentation": 12.5,
      "databaseSize": 2.5,
      "archiveSize": 1.2
    }
  }
}
```

---

### 更新任务配置

```http
PUT /api/tightening/maintenance/jobs/:jobName
Content-Type: application/json

{
  "enabled": true,
  "daysToKeep": 100
}
```

---

### 执行单个任务

```http
POST /api/tightening/maintenance/run/:jobName
```

---

### 执行所有启用任务

```http
POST /api/tightening/maintenance/run-all
```

**响应**:
```json
{
  "success": true,
  "message": "已执行 3/5 个维护任务",
  "results": [
    {
      "success": true,
      "message": "删除维护任务完成",
      "job": "ToolsNet_DeleteMaintenance",
      "details": { ... }
    },
    {
      "success": true,
      "message": "未绑定曲线删除完成",
      "job": "ToolsNet_DeleteUnboundGraphs",
      "details": { ... }
    },
    {
      "success": true,
      "message": "索引重组完成",
      "job": "ToolsNet_IndexReorganize",
      "details": { ... }
    }
  ]
}
```

---

### 获取维护统计

```http
GET /api/tightening/maintenance/statistics
```

---

## 📈 性能优化

### 索引优化建议

#### 何时使用 Reorganize
- 碎片率 5%-30%
- 需要在线操作
- 每日维护

#### 何时使用 Rebuild
- 碎片率 > 30%
- 可以接受短暂锁表
- 每周深度维护

### 数据清理策略

| 数据类型 | 建议保留期 | 归档策略 |
|---------|-----------|---------|
| **拧紧结果** | 90天 | 超过3个月归档 |
| **拧紧曲线** | 30天 | 超过1个月归档 |
| **控制器事件** | 180天 | 超过6个月归档 |
| **程序版本** | 365天 | 超过1年归档 |

---

## 🔒 安全特性

### 权限控制
- 需要管理员权限
- 任务执行日志记录
- 配置变更追踪

### 数据安全
- 归档前数据验证
- 删除操作事务保护
- 自动备份机制

---

## 📝 最佳实践

### 1. 配置建议

```javascript
// 生产环境推荐配置
const productionConfig = {
  deleteMaintenanceJob: {
    enabled: true,
    daysToKeep: 90,  // 根据业务需求调整
    schedule: 'daily-03:00'  // 凌晨3点执行
  },
  indexReorganizeJob: {
    enabled: true,
    schedule: 'daily-02:00-except-sunday'
  },
  indexRebuildJob: {
    enabled: true,
    schedule: 'sunday-01:00'  // 周日凌晨1点
  },
  archiveJob: {
    enabled: true,
    schedule: 'first-day-of-quarter'  // 每季度第一天
  }
}
```

### 2. 监控指标

- **索引碎片率**: 保持 < 10%
- **数据库大小**: 监控增长趋势
- **归档成功率**: 保持 > 95%
- **任务执行时间**: 监控异常

### 3. 故障处理

#### 任务执行失败
1. 检查数据库连接
2. 查看错误日志
3. 手动重试
4. 联系技术支持

#### 性能下降
1. 检查索引碎片率
2. 执行索引重建
3. 清理过期数据
4. 优化归档策略

---

## 🎓 技术细节

### 数据库表设计

#### connection_logs (连接日志)
```sql
CREATE TABLE connection_logs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  controller_id VARCHAR(50),
  connect_time DATETIME,
  disconnect_time DATETIME,
  duration INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

#### maintenance_logs (维护日志)
```sql
CREATE TABLE maintenance_logs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  job_name VARCHAR(100),
  status VARCHAR(20),
  start_time DATETIME,
  end_time DATETIME,
  details JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

---

## 📚 相关文档

- [功能文档_拧紧数据采集系统_ToolsNet8架构_2025-12-14_v3.0.0.md](./功能文档_拧紧数据采集系统_ToolsNet8架构_2025-12-14_v3.0.0.md)
- [快速入门_拧紧数据采集分析_2025-12-14.md](./快速入门_拧紧数据采集分析_2025-12-14.md)
- [ToolsNet 8 官方文档](https://www.atlascopco.com/)

---

## ✅ 完成清单

- [x] 后端API实现（5个维护任务）
- [x] 前端UI界面
- [x] 任务配置管理
- [x] 统计信息展示
- [x] 批量操作支持
- [x] 错误处理
- [x] 日志记录
- [x] 文档编写

---

## 🚀 下一步

### 计划功能

1. **定时任务调度**
   - 集成 node-cron
   - 自动执行维护任务
   - 邮件通知

2. **高级归档策略**
   - 自定义归档规则
   - 分级归档
   - 归档数据查询

3. **性能监控**
   - 实时性能指标
   - 告警阈值设置
   - 性能趋势分析

---

**版本历史**:
- v1.0.0 (2025-12-14): 初始版本 - ToolsNet Database Jobs完整实现

**作者**: AI 智能助手  
**更新时间**: 2025-12-14

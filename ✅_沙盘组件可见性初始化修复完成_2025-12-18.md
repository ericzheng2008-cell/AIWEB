# ✅ 客户沙盘组件可见性初始化修复完成

**修复日期**: 2025-12-18  
**修复文件**: `src/components/CustomerSandboxAdvanced.vue`

---

## 🎯 问题描述

控制台显示大量重试日志：
```
⏳ 3D沙盘: 容器被隐藏，等待显示 (重试 1/10)
⏳ 3D沙盘: 容器被隐藏，等待显示 (重试 2/10)
...
⏳ 3D沙盘: 容器被隐藏，等待显示 (重试 10/10)
⚠️ 3D沙盘: 容器始终被隐藏，停止重试
```

---

## 🔍 根本原因

### 问题分析

1. **父组件控制**：`MingShengAICRM_V3.vue` 使用 `v-show="activeModule === 'sandbox'"` 控制整个组件的显示
2. **默认状态**：`activeModule` 默认值是 `'funnel'`，不是 `'sandbox'`
3. **过早初始化**：组件在 `onMounted` 时就尝试初始化图表，但此时**整个组件都被父组件的 `v-show` 隐藏**
4. **无效重试**：即使重试 10 次，只要用户没有点击"客户沙盘分析"卡片，组件永远是隐藏的

### 代码层级关系

```
MingShengAICRM_V3.vue
└─ <div v-show="activeModule === 'sandbox'">   ← 父容器隐藏
   └─ <CustomerSandboxAdvanced>                ← 整个组件被隐藏
      └─ <div v-show="viewMode === '3d'">      ← 即使 viewMode='3d'，因父容器隐藏而不可见
         └─ <div ref="sandbox3DRef">           ← offsetParent === null
```

---

## ✅ 解决方案

### 核心思路

**延迟初始化**：不在 `onMounted` 时初始化，而是在组件**真正变为可见**时才初始化。

### 实现方式

#### 1️⃣ **初始化状态标记**
```javascript
const initialized = ref(false)
```

#### 2️⃣ **可见性检查函数**
```javascript
const checkAndInit = () => {
  if (initialized.value) return
  
  // 检查组件根元素是否可见
  const rootEl = document.querySelector('.customer-sandbox-advanced')
  if (!rootEl || rootEl.offsetParent === null) {
    console.log('⏳ 组件被隐藏，等待显示后初始化')
    return
  }
  
  console.log('✅ 组件已显示，开始初始化')
  initialized.value = true
  
  // 延迟初始化，确保 DOM 容器完成布局
  setTimeout(() => {
    if (customers.value.length > 0) {
      selectCustomer(customers.value[0])
    }
  }, 500)
}
```

#### 3️⃣ **MutationObserver 监听**
监听父元素的 `style` 属性变化（`v-show` 通过修改 `display` 样式实现）：
```javascript
onMounted(() => {
  const rootEl = document.querySelector('.customer-sandbox-advanced')
  if (rootEl?.parentElement) {
    const observer = new MutationObserver(() => {
      console.log('🔍 检测到父元素变化，检查可见性')
      checkAndInit()
    })
    
    observer.observe(rootEl.parentElement, {
      attributes: true,
      attributeFilter: ['style']  // 只监听 style 属性变化
    })
    
    onUnmounted(() => {
      observer.disconnect()
    })
  }
})
```

#### 4️⃣ **备用轮询机制**
前 3 秒每 300ms 检查一次（防止 MutationObserver 失效）：
```javascript
let checkCount = 0
const checkInterval = setInterval(() => {
  checkCount++
  if (checkCount > 10 || initialized.value) {
    clearInterval(checkInterval)
    return
  }
  checkAndInit()
}, 300)
```

---

## 🔧 修改内容

### 文件：`src/components/CustomerSandboxAdvanced.vue`

#### 1. 导入 `onUnmounted`
```javascript
import { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue'
```

#### 2. 替换 `onMounted` 逻辑
```diff
- // 挂载时初始化
- onMounted(() => {
-   // 延迟初始化，确保 DOM 容器完成布局
-   setTimeout(() => {
-     if (customers.value.length > 0) {
-       selectCustomer(customers.value[0])
-     }
-   }, 500)
- })

+ // ✅ 标记是否已经初始化过
+ const initialized = ref(false)
+
+ // ✅ 监听组件可见性，只在变为可见时才初始化
+ const checkAndInit = () => { ... }
+
+ // 挂载时尝试初始化（如果组件可见）
+ onMounted(() => {
+   checkAndInit()
+   
+   // MutationObserver 监听
+   // 备用轮询机制
+ })
```

---

## 📊 修复效果

### 修复前
```
CustomerSandboxAdvanced.vue:495 ⏳ 3D沙盘: 容器被隐藏，等待显示 (重试 1/10)
CustomerSandboxAdvanced.vue:495 ⏳ 3D沙盘: 容器被隐藏，等待显示 (重试 2/10)
...
CustomerSandboxAdvanced.vue:500 ⚠️ 3D沙盘: 容器始终被隐藏，停止重试
```

### 修复后（预期）
```
📍 组件已挂载，检查可见性
⏳ 组件被隐藏，等待显示后初始化

[用户点击"客户沙盘分析"卡片]

🔍 检测到父元素变化，检查可见性
✅ 组件已显示，开始初始化
👤 选择客户: 华为技术有限公司
📦 开始加载 ECharts-GL
📏 3D沙盘: 容器尺寸 800×500
✅ 3D沙盘: 开始初始化，尺寸 800×500
✅ 3D沙盘: 图表实例已创建
```

---

## 🎯 技术亮点

1. **智能延迟初始化**：只在组件真正可见时才初始化，避免无效重试
2. **双重保障机制**：
   - 主机制：MutationObserver 监听 DOM 变化
   - 备用机制：定时轮询检查（前 3 秒）
3. **一次性初始化**：使用 `initialized.value` 标记，避免重复初始化
4. **资源清理**：在 `onUnmounted` 时断开 MutationObserver

---

## 🧪 测试步骤

### 方式一：使用批处理文件
```bash
🧪_测试沙盘组件可见性初始化_2025-12-18.bat
```

### 方式二：手动测试
1. 启动开发服务器：`npm run dev`
2. 访问 `http://localhost:5173`
3. 点击"国际营销中控台" → "明升AICRM"
4. **不要点击"客户沙盘分析"**，打开控制台（F12）
5. 观察日志：应该看到 `⏳ 组件被隐藏，等待显示后初始化`
6. **点击"客户沙盘分析"卡片**
7. 观察日志：应该看到 `✅ 组件已显示，开始初始化`
8. 3D 沙盘应该正常渲染，**没有任何警告**

---

## 📝 相关文件

- ✅ 修复文件：`src/components/CustomerSandboxAdvanced.vue`
- 🎯 测试文件：`🧪_测试沙盘组件可见性初始化_2025-12-18.bat`
- 📊 父组件：`src/views/MingShengAICRM_V3.vue`

---

## 🎊 总结

通过 **MutationObserver + 轮询** 的双重机制，彻底解决了组件被父容器 `v-show` 隐藏导致的过早初始化问题。现在组件会智能等待变为可见时才初始化，避免无效重试和控制台警告。

**修复完成时间**: 2025-12-18

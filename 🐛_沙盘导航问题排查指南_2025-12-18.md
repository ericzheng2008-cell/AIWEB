# 🐛 沙盘导航问题排查指南

**问题描述**: 点击"客户沙盘"菜单项后无反应

**排查日期**: 2025-12-18

---

## 🔍 问题诊断步骤

### 1️⃣ 检查菜单点击事件

**操作**：
1. 打开浏览器控制台（F12）
2. 点击菜单栏的"客户沙盘"按钮
3. 查看控制台输出

**预期日志**：
```
🔄 切换模块: funnel → sandbox
✅ 当前模块: sandbox
```

**如果没有日志**：
- ❌ 菜单点击事件未触发
- 🔧 **解决方案**：检查 `@select="handleModuleChange"` 绑定

---

### 2️⃣ 检查组件可见性切换

**预期日志**（点击后应立即出现）：
```
🔍 检测到父元素变化，检查可见性
🎉 组件已显示，开始初始化！
```

**如果没有此日志**：
- ❌ MutationObserver 未触发
- ❌ `v-show="activeModule === 'sandbox'"` 未生效

---

### 3️⃣ 检查组件初始化

**预期日志**（组件可见后 0.5 秒）：
```
👤 选择客户: 华为技术有限公司
📦 开始加载 ECharts-GL
✅ ECharts-GL 加载完成
📏 3D沙盘: 容器尺寸 XXX×XXX
✅ 3D沙盘: 图表实例已创建
```

**如果没有此日志**：
- ❌ 组件初始化失败
- ❌ 容器尺寸为 0

---

## 🛠️ 可能的原因与解决方案

### 原因 1：菜单绑定问题

**症状**：点击后无任何日志

**检查代码**：
```vue
<!-- MingShengAICRM_V3.vue -->
<el-menu 
  :default-active="activeModule"
  @select="handleModuleChange"  <!-- 确认此行存在 -->
>
  <el-menu-item index="sandbox">  <!-- 确认 index="sandbox" -->
    客户沙盘
  </el-menu-item>
</el-menu>
```

**解决方案**：
```javascript
const handleModuleChange = (key) => {
  console.log(`🔄 切换模块: ${activeModule.value} → ${key}`)
  activeModule.value = key  // 确认此行执行
}
```

---

### 原因 2：v-show 条件错误

**症状**：有"切换模块"日志，但组件未显示

**检查代码**：
```vue
<!-- MingShengAICRM_V3.vue -->
<div v-show="activeModule === 'sandbox'" class="sandbox-module">
  <CustomerSandboxAdvanced />
</div>
```

**验证方法**：
```javascript
// 在控制台执行
document.querySelector('.sandbox-module')?.style.display
// 应该返回 '' 或 'block'，不应该是 'none'
```

---

### 原因 3：组件未注册

**症状**：控制台报错 "Failed to resolve component"

**检查代码**：
```vue
<script setup>
import CustomerSandboxAdvanced from '@/components/CustomerSandboxAdvanced.vue'
</script>
```

---

### 原因 4：MutationObserver 未生效

**症状**：组件显示但未初始化

**调试代码**（临时添加）：
```javascript
// CustomerSandboxAdvanced.vue - onMounted 中
onMounted(() => {
  console.log('📍 组件已挂载')
  
  const rootEl = document.querySelector('.customer-sandbox-advanced')
  console.log('🔍 根元素:', rootEl)
  console.log('🔍 父元素:', rootEl?.parentElement)
  console.log('🔍 父元素 display:', rootEl?.parentElement?.style.display)
  
  checkAndInit()
})
```

---

## 🔧 快速修复方案

### 方案 1：手动触发初始化（临时）

在 `CustomerSandboxAdvanced.vue` 中修改 `watch`：

```javascript
// 添加立即执行选项
watch(viewMode, (newMode) => {
  setTimeout(() => {
    if (newMode === '3d') {
      render3DSandbox()
    }
  }, 300)
}, { flush: 'post', immediate: true })  // 添加 immediate
```

---

### 方案 2：使用 nextTick 替代 MutationObserver

```javascript
// 在 handleModuleChange 中
const handleModuleChange = (key) => {
  activeModule.value = key
  
  // 如果切换到沙盘，手动触发初始化
  if (key === 'sandbox') {
    nextTick(() => {
      const event = new CustomEvent('sandbox-visible')
      window.dispatchEvent(event)
    })
  }
}
```

```javascript
// 在 CustomerSandboxAdvanced 中监听
onMounted(() => {
  window.addEventListener('sandbox-visible', checkAndInit)
  
  onUnmounted(() => {
    window.removeEventListener('sandbox-visible', checkAndInit)
  })
})
```

---

### 方案 3：使用 Teleport + 路由（推荐长期方案）

将沙盘分析改为独立路由页面：

```javascript
// router/index.js
{
  path: '/crm/sandbox',
  component: () => import('@/components/CustomerSandboxAdvanced.vue')
}
```

```javascript
// 点击时跳转
const handleModuleChange = (key) => {
  if (key === 'sandbox') {
    router.push('/crm/sandbox')
  } else {
    activeModule.value = key
  }
}
```

---

## 📊 诊断日志示例

### ✅ 正常情况
```
用户点击"客户沙盘"
  ↓
🔄 切换模块: funnel → sandbox
✅ 当前模块: sandbox
  ↓
🔍 检测到父元素变化，检查可见性
🎉 组件已显示，开始初始化！
  ↓
👤 选择客户: 华为技术有限公司
📦 开始加载 ECharts-GL
✅ ECharts-GL 加载完成
  ↓
📏 3D沙盘: 容器尺寸 800×500
✅ 3D沙盘: 图表实例已创建
```

### ❌ 异常情况 1：菜单未响应
```
用户点击"客户沙盘"
  ↓
（无任何日志）
```
**问题**：`@select` 事件未绑定或未触发

### ❌ 异常情况 2：组件未显示
```
用户点击"客户沙盘"
  ↓
🔄 切换模块: funnel → sandbox
✅ 当前模块: sandbox
  ↓
（无更多日志）
```
**问题**：`v-show` 未生效或 MutationObserver 未触发

### ❌ 异常情况 3：组件显示但未初始化
```
用户点击"客户沙盘"
  ↓
🔄 切换模块: funnel → sandbox
✅ 当前模块: sandbox
  ↓
🔍 检测到父元素变化，检查可见性
⏳ 组件被隐藏，等待显示后初始化
```
**问题**：容器仍被判定为隐藏（`offsetParent === null`）

---

## 🧪 测试工具

运行诊断批处理文件：
```bash
🔍_诊断沙盘导航问题_2025-12-18.bat
```

---

## 📞 下一步行动

1. **立即测试**：运行诊断批处理文件
2. **收集日志**：将控制台日志完整复制
3. **分析问题**：根据日志定位具体原因
4. **应用修复**：选择合适的解决方案

---

**创建时间**: 2025-12-18  
**状态**: 等待测试反馈

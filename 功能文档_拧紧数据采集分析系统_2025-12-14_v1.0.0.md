# 拧紧数据采集分析系统

**开发日期**: 2025-12-14  
**版本**: v1.0.0  
**模块**: 工艺优化 - 数据采集分析

---

## 📋 系统概述

基于**Open Protocol协议**的拧紧数据采集分析系统，支持从PF4000/PF8000等数字电动工具控制器实时采集拧紧结果和曲线数据，提供全面的数据清洗、统计分析、异常检测和报警功能。

### 核心特性

✅ **Open Protocol协议支持** - 标准工业通讯协议  
✅ **实时数据采集** - 连续监控拧紧过程  
✅ **数据清洗筛选** - 多维度数据过滤  
✅ **统计分析** - OK率、Cpk等工艺能力分析  
✅ **拧紧曲线可视化** - 扭矩-角度曲线展示  
✅ **异常检测报警** - 实时监控和预警  
✅ **数据导出** - CSV格式批量导出

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────┐
│          拧紧数据采集分析系统                │
├─────────────────────────────────────────────┤
│                                             │
│  ┌──────────────┐    ┌──────────────┐      │
│  │ Open Protocol│ ←→ │   控制器     │      │
│  │   通讯模块   │    │ PF4000/8000  │      │
│  └──────────────┘    └──────────────┘      │
│         ↓                                   │
│  ┌──────────────────────────────┐          │
│  │      数据采集引擎            │          │
│  │  - 实时采集                  │          │
│  │  - 数据验证                  │          │
│  │  - 数据清洗                  │          │
│  └──────────────────────────────┘          │
│         ↓                                   │
│  ┌─────────┬──────────┬─────────┐          │
│  │ 统计分析 │ 曲线分析 │ 异常检测│          │
│  └─────────┴──────────┴─────────┘          │
│         ↓                                   │
│  ┌──────────────────────────────┐          │
│  │      可视化展示层            │          │
│  │  - 实时监控                  │          │
│  │  - 统计图表                  │          │
│  │  - 报警提示                  │          │
│  └──────────────────────────────┘          │
└─────────────────────────────────────────────┘
```

---

## 🔧 Open Protocol 协议说明

### 协议特点
- **标准端口**: 4545
- **通讯方式**: TCP/IP
- **数据格式**: ASCII字符串
- **消息类型**: 
  - MID 0001: 通讯启动
  - MID 0061: 拧紧结果订阅
  - MID 0065: 拧紧结果数据
  - MID 0071: 曲线数据订阅
  - MID 0074: 曲线数据

### 支持的控制器
1. **PF4000** - 标准型控制器
   - 支持拧紧结果采集
   - 支持基本曲线数据
   - 最多64个程序(Pset)

2. **PF8000** - 高级型控制器
   - 完整Open Protocol支持
   - 高精度曲线数据
   - 支持复杂拧紧策略

---

## 📊 功能模块详解

### 1. 控制器连接模块

#### 连接配置
```javascript
{
  controller: 'PF4000',      // 控制器类型
  ipAddress: '192.168.1.100', // IP地址
  port: 4545,                 // 端口
  timeout: 5000              // 超时时间(ms)
}
```

#### 连接状态
- **未连接** (disconnected)
- **连接中** (connecting)  
- **已连接** (connected)

#### 操作按钮
- **连接控制器** - 建立TCP连接
- **断开连接** - 关闭连接
- **使用模拟数据** - 开发测试用

---

### 2. 实时数据采集

#### 采集内容
| 字段 | 说明 | 示例 |
|------|------|------|
| Pset ID | 程序编号 | 1 |
| Job ID | 作业编号 | 100 |
| Batch ID | 批次编号 | BATCH-001 |
| Result | 拧紧结果 | OK/NOK |
| Torque | 最终扭矩 | 35.2 Nm |
| Target Torque | 目标扭矩 | 35.0 Nm |
| Angle | 最终角度 | 185.5° |
| Target Angle | 目标角度 | 180.0° |
| Time | 拧紧时间 | 1.234 s |
| NOK Reason | 失败原因 | 扭矩过低 |

#### 实时监控界面
- 📊 **数据表格** - 最近50条拧紧记录
- 🎨 **颜色标识** - NOK结果红色高亮
- 📈 **扭矩进度条** - 可视化扭矩达成率
- 🔍 **快速操作** - 查看曲线、查看详情

---

### 3. 数据清洗与筛选

#### 筛选维度
```javascript
filters: {
  dateRange: [startDate, endDate],  // 时间范围
  result: 'all',                    // 结果类型: all/ok/nok
  psetId: null,                     // Pset筛选
  jobId: null,                      // Job筛选
  batchId: null                     // 批次筛选
}
```

#### 数据清洗规则
1. **数据验证**
   - 扭矩值范围检查 (0-1000Nm)
   - 角度值范围检查 (0-3600°)
   - 时间戳完整性验证

2. **异常值处理**
   - 识别明显异常数据
   - 标记但不删除
   - 可选择排除异常值

3. **数据去重**
   - 检测重复记录
   - 保留最新数据

---

### 4. 统计分析模块

#### 基础统计
- **总拧紧数** - 统计周期内的总数
- **合格数 (OK)** - 拧紧成功的数量
- **不合格数 (NOK)** - 拧紧失败的数量
- **合格率** - OK数 / 总数 × 100%
- **平均扭矩** - 所有拧紧的平均扭矩值
- **平均角度** - 所有拧紧的平均角度值
- **平均时间** - 所有拧紧的平均用时

#### Cpk过程能力分析

**计算公式:**
```
Cpu = (USL - μ) / (3σ)
Cpl = (μ - LSL) / (3σ)
Cpk = min(Cpu, Cpl)
```

**参数说明:**
- USL: 上限规格 (Upper Specification Limit)
- LSL: 下限规格 (Lower Specification Limit)
- μ: 均值 (Mean)
- σ: 标准差 (Standard Deviation)

**Cpk等级:**
| Cpk值 | 等级 | 说明 |
|-------|------|------|
| ≥ 1.67 | 优秀 ✅ | 过程能力充足 |
| 1.33 - 1.67 | 良好 ⚠️ | 过程能力基本满足 |
| < 1.33 | 不足 ❌ | 过程能力不足，需改进 |

**应用场景:**
- 评估拧紧工艺稳定性
- 识别需要优化的Pset
- 质量体系审核依据

---

### 5. 拧紧曲线可视化

#### 曲线类型
1. **扭矩-角度曲线**
   ```
   Y轴: 扭矩 (Nm)
   X轴: 角度 (°)
   ```

2. **扭矩-时间曲线**
   ```
   Y轴: 扭矩 (Nm)
   X轴: 时间 (s)
   ```

#### 曲线特征分析
- **峰值扭矩** - 拧紧过程中的最大扭矩
- **峰值角度** - 达到峰值时的角度
- **拧紧斜率** - 扭矩上升速率
- **残余扭矩** - 最终保持的扭矩

#### 异常曲线识别
| 异常类型 | 特征 | 原因 |
|---------|------|------|
| 早期峰值 | 角度很小时达到目标扭矩 | 螺纹损坏、异物 |
| 平缓曲线 | 扭矩上升缓慢 | 螺纹配合松、力矩设定低 |
| 多峰曲线 | 出现多个峰值 | 打滑、交叉螺纹 |
| 突降曲线 | 扭矩突然下降 | 螺栓断裂、螺纹剥牙 |

---

### 6. 异常检测与报警

#### 报警类型

##### 1. NOK结果报警 ⚠️
```
触发条件: result === 'NOK'
报警级别: 警告 (Warning)
报警内容: 拧紧NOK - {nokReason}
```

##### 2. 扭矩偏差报警 🔴
```
触发条件: |实际扭矩 - 目标扭矩| / 目标扭矩 > 阈值
默认阈值: 10%
报警级别: 错误 (Error)
报警内容: 扭矩偏差过大: XX% (目标: XXNm, 实际: XXNm)
```

##### 3. 角度偏差报警 ⚠️
```
触发条件: |实际角度 - 目标角度| / 目标角度 > 阈值
默认阈值: 15%
报警级别: 警告 (Warning)
报警内容: 角度偏差过大: XX% (目标: XX°, 实际: XX°)
```

##### 4. 连续NOK报警 🚨
```
触发条件: 连续N次拧紧均为NOK
默认阈值: 3次
报警级别: 严重 (Critical)
报警内容: 连续3次拧紧NOK，请检查设备和工艺参数
```

##### 5. Cpk低值报警 📉
```
触发条件: Cpk < 阈值
默认阈值: 1.33
报警级别: 警告 (Warning)
报警内容: 过程能力不足，Cpk = XX，建议优化工艺参数
```

#### 报警配置
```javascript
alarmConfig: {
  enabled: true,              // 启用报警
  nokAlarm: true,            // NOK结果报警
  torqueDeviation: 10,       // 扭矩偏差阈值 (%)
  angleDeviation: 15,        // 角度偏差阈值 (%)
  consecutiveNok: 3,         // 连续NOK次数
  lowCpk: 1.33              // Cpk低值阈值
}
```

---

### 7. 数据导出功能

#### 导出格式: CSV

**文件名格式:**
```
拧紧数据_2025-12-14.csv
```

**数据字段:**
```csv
时间,Pset ID,Job ID,结果,扭矩(Nm),角度(°),拧紧时间(s),NOK原因
2025-12-14 10:30:15,1,100,OK,35.2,185.5,1.234,
2025-12-14 10:30:45,1,100,NOK,28.5,175.2,1.156,扭矩过低
...
```

#### 导出步骤
1. 应用数据筛选条件
2. 点击"导出数据"按钮
3. 自动下载CSV文件
4. 支持Excel打开

---

## 📈 可视化图表

### 1. OK率趋势图
```
类型: 折线图
X轴: 拧紧次数
Y轴: OK率 (%)
功能: 展示质量趋势
```

### 2. 扭矩分布图
```
类型: 散点图
X轴: 扭矩值 (Nm)
Y轴: 频次
功能: 识别扭矩分布特征
颜色: 根据偏差程度标识
  - 绿色: 偏差 < 5%
  - 橙色: 偏差 5-10%
  - 红色: 偏差 > 10%
```

### 3. 拧紧曲线图
```
类型: 平滑曲线
X轴: 角度 (°)
Y轴: 扭矩 (Nm)
功能: 展示拧紧过程
特性: 
  - 平滑曲线
  - 面积填充
  - 交互式缩放
```

---

## 🎯 使用场景

### 场景1: 新产品试生产质量验证

**背景**: 新车型底盘螺栓拧紧工艺验证

**操作流程**:
1. 连接PF4000控制器
2. 设置筛选: Pset ID = 1 (底盘螺栓)
3. 开始采集数据
4. 拧紧30个样本
5. 查看统计分析:
   - OK率: 93.3%
   - Cpk: 1.52 (良好)
   - 平均扭矩: 45.2Nm
6. 导出数据用于质量报告

**结果**: 工艺参数验证通过 ✅

---

### 场景2: 生产线质量问题排查

**背景**: 某工位连续出现NOK，需要快速定位

**操作流程**:
1. 切换到"异常报警"tab
2. 发现报警: "连续3次拧紧NOK"
3. 查看NOK原因: 均为"扭矩过低"
4. 查看拧紧曲线: 发现曲线平缓
5. 分析结论: 电池电量不足
6. 采取措施: 更换电池

**结果**: 问题快速解决，避免批量不良 ✅

---

### 场景3: 工艺优化Cpk提升

**背景**: 某Pset的Cpk仅为1.25，需要改善

**操作流程**:
1. 筛选该Pset的历史数据
2. 查看Cpk分析:
   - Cpk: 1.25
   - μ: 35.5Nm (目标35Nm)
   - σ: 2.1Nm
3. 查看扭矩分布图: 发现数据偏上限
4. 调整策略: 降低目标扭矩至34.5Nm
5. 重新采集30个样本
6. 新的Cpk: 1.48 ✅

**结果**: 过程能力提升，达到良好水平 ✅

---

### 场景4: 质量体系审核数据支撑

**背景**: ISO9001审核需要提供拧紧工艺能力证据

**操作流程**:
1. 设置日期范围: 最近3个月
2. 筛选关键Pset (5个)
3. 导出所有拧紧数据
4. 生成统计报告:
   - 总拧紧数: 15,234
   - OK率: 98.2%
   - 所有Pset的Cpk > 1.33
5. 打印曲线和趋势图
6. 提交审核组

**结果**: 顺利通过审核 ✅

---

## 💡 最佳实践

### 1. 数据采集
- ✅ 保持控制器与系统在同一网络
- ✅ 定期检查连接状态
- ✅ 设置合理的采集频率
- ⚠️ 避免在高负载时段采集大量数据

### 2. 数据分析
- ✅ 使用合理的时间范围筛选
- ✅ 对比不同Pset的质量差异
- ✅ 定期计算Cpk并跟踪趋势
- ⚠️ 注意数据量不足时Cpk可能不准确

### 3. 异常处理
- ✅ 启用所有报警类型
- ✅ 设置合理的报警阈值
- ✅ 及时响应严重报警
- ⚠️ 避免报警阈值过于敏感导致误报

### 4. 数据管理
- ✅ 定期导出重要数据备份
- ✅ 清理过期的历史数据
- ✅ 建立数据归档制度
- ⚠️ 本地最多保存10000条记录

---

## 🔒 数据存储

### 本地存储
```javascript
localStorage:
  - tighteningResults: 最近1000条结果
  - tighteningCurves: 最近100条曲线
  - alarmConfig: 报警配置
```

### 数据容量限制
- **拧紧结果**: 内存10000条，本地1000条
- **拧紧曲线**: 内存1000条，本地100条
- **异常记录**: 内存1000条

### 清理策略
- 达到上限时自动删除最旧数据
- 支持手动清空所有数据
- 导出后可选择清理

---

## 🚀 后续扩展方向

### Phase 2 - 高级分析
- [ ] SPC统计过程控制
- [ ] 控制图 (X-bar, R图)
- [ ] 趋势预测
- [ ] 多Pset对比分析

### Phase 3 - 智能化
- [ ] AI异常模式识别
- [ ] 自动参数优化建议
- [ ] 预测性维护
- [ ] 智能报警降噪

### Phase 4 - 集成
- [ ] MES系统对接
- [ ] ERP数据同步
- [ ] 移动端应用
- [ ] 多控制器并行采集

---

## 📞 技术支持

### 常见问题

**Q: 无法连接到控制器？**
A: 检查网络连接、IP地址配置、防火墙设置

**Q: Cpk计算不准确？**
A: 确保样本量 ≥ 30，检查目标扭矩和公差设置

**Q: 数据丢失？**
A: 定期导出备份，检查浏览器存储空间

**Q: 报警太频繁？**
A: 调整报警阈值，排查工艺稳定性问题

---

## 📝 更新日志

### v1.0.0 (2025-12-14)
- ✅ Open Protocol协议支持
- ✅ PF4000/PF8000控制器连接
- ✅ 实时数据采集
- ✅ 数据清洗筛选
- ✅ 统计分析 (OK率、Cpk)
- ✅ 拧紧曲线可视化
- ✅ 异常检测报警
- ✅ CSV数据导出

---

**开发团队**: AI Assistant  
**文档版本**: v1.0.0  
**最后更新**: 2025-12-14

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” 500é”™è¯¯å®Œæ•´è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        .section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .status {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        .status.checking {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .icon {
            font-size: 1.5em;
            margin-right: 15px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn:active {
            transform: translateY(0);
        }
        .result-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            overflow-x: auto;
        }
        .error-detail {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .solution-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .api-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .api-test h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .progress {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” 500é”™è¯¯å®Œæ•´è¯Šæ–­å·¥å…·</h1>
            <p>è‡ªåŠ¨æ£€æµ‹åç«¯æœåŠ¡å™¨ã€APIæ¥å£ã€å‰ç«¯é…ç½®</p>
        </div>

        <div class="section">
            <h2>ğŸ“Š è¯Šæ–­æ§åˆ¶å°</h2>
            <button class="btn" onclick="runFullDiagnosis()">ğŸš€ è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="btn" onclick="testBackendServer()">ğŸ”§ ä»…æµ‹è¯•åç«¯</button>
            <button class="btn" onclick="testAllAPIs()">ğŸ“¡ æµ‹è¯•æ‰€æœ‰API</button>
            <button class="btn" onclick="checkFrontendConfig()">âš™ï¸ æ£€æŸ¥å‰ç«¯é…ç½®</button>
            <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ¯ è¯Šæ–­ç»“æœ</h2>
            <div id="results"></div>
        </div>

        <div class="section">
            <h2>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h2>
            <div id="solutions"></div>
        </div>
    </div>

    <script>
        const results = document.getElementById('results');
        const solutions = document.getElementById('solutions');
        const progressBar = document.getElementById('progressBar');
        
        let totalSteps = 0;
        let completedSteps = 0;
        let issues = [];

        function updateProgress() {
            const percent = (completedSteps / totalSteps) * 100;
            progressBar.style.width = percent + '%';
        }

        function addResult(type, icon, message) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<span class="icon">${icon}</span><span>${message}</span>`;
            results.appendChild(div);
            completedSteps++;
            updateProgress();
        }

        function addSolution(title, steps) {
            const div = document.createElement('div');
            div.className = 'solution-box';
            div.innerHTML = `<h3>âœ… ${title}</h3>` + steps;
            solutions.appendChild(div);
        }

        function addErrorDetail(error, api) {
            const div = document.createElement('div');
            div.className = 'error-detail';
            div.innerHTML = `
                <h4>âŒ APIé”™è¯¯è¯¦æƒ…</h4>
                <p><strong>æ¥å£:</strong> ${api}</p>
                <p><strong>é”™è¯¯:</strong> ${error}</p>
            `;
            results.appendChild(div);
        }

        async function runFullDiagnosis() {
            results.innerHTML = '';
            solutions.innerHTML = '';
            issues = [];
            completedSteps = 0;
            totalSteps = 10;
            progressBar.style.width = '0%';

            addResult('checking', 'â³', 'å¼€å§‹å®Œæ•´è¯Šæ–­...');

            // Step 1: æ£€æŸ¥åç«¯æœåŠ¡å™¨ (ç«¯å£5000)
            await testBackendServer();

            // Step 2: æ£€æŸ¥å‰ç«¯æœåŠ¡å™¨ (ç«¯å£3002/5173)
            await testFrontendServer();

            // Step 3: æµ‹è¯•æ‰€æœ‰APIæ¥å£
            await testAllAPIs();

            // Step 4: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°
            checkBrowserConsole();

            // Step 5: ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
            generateSolutions();

            addResult('success', 'âœ…', 'è¯Šæ–­å®Œæˆï¼');
        }

        async function testBackendServer() {
            addResult('checking', 'ğŸ”', 'æ£€æŸ¥åç«¯æœåŠ¡å™¨ (ç«¯å£5000)...');

            const ports = [5000, 3001, 3000];
            let backendRunning = false;
            let runningPort = null;

            for (const port of ports) {
                try {
                    const response = await fetch(`http://localhost:${port}/api`, {
                        method: 'GET',
                        timeout: 3000
                    });
                    
                    backendRunning = true;
                    runningPort = port;
                    addResult('success', 'âœ…', `åç«¯æœåŠ¡å™¨è¿è¡Œä¸­ (ç«¯å£${port})`);
                    break;
                } catch (error) {
                    console.log(`ç«¯å£${port}æ£€æµ‹å¤±è´¥:`, error.message);
                }
            }

            if (!backendRunning) {
                addResult('error', 'âŒ', 'åç«¯æœåŠ¡å™¨æœªè¿è¡Œï¼');
                issues.push({
                    type: 'backend_not_running',
                    message: 'åç«¯æœåŠ¡å™¨æœªå¯åŠ¨',
                    solution: 'start_backend'
                });
            }

            return { running: backendRunning, port: runningPort };
        }

        async function testFrontendServer() {
            addResult('checking', 'ğŸ”', 'æ£€æŸ¥å‰ç«¯æœåŠ¡å™¨...');

            const currentPort = window.location.port || '80';
            const currentHost = window.location.hostname;

            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                addResult('success', 'âœ…', `å‰ç«¯æœåŠ¡å™¨è¿è¡Œä¸­ (ç«¯å£${currentPort})`);
            } else {
                addResult('warning', 'âš ï¸', `è¿è¡Œåœ¨éæœ¬åœ°ç¯å¢ƒ: ${currentHost}`);
            }
        }

        async function testAllAPIs() {
            addResult('checking', 'ğŸ”', 'æµ‹è¯•æ‰€æœ‰APIæ¥å£...');

            const apiTests = [
                { name: 'è®¤è¯API', url: '/api/auth/register', method: 'POST', data: {} },
                { name: 'äº§å“API', url: '/api/products', method: 'GET' },
                { name: 'å†…å®¹API', url: '/api/content', method: 'GET' },
                { name: 'ç”¨æˆ·API', url: '/api/user/info', method: 'GET' },
                { name: 'æ‹§ç´§æ•°æ®API', url: '/api/tightening/results', method: 'GET' },
                { name: 'æ–‡ä»¶ä¸Šä¼ API', url: '/api/upload', method: 'POST' }
            ];

            const baseUrls = ['http://localhost:5000', 'http://localhost:3001'];
            let workingBaseUrl = null;

            // æ‰¾åˆ°å·¥ä½œçš„base URL
            for (const baseUrl of baseUrls) {
                try {
                    const response = await fetch(`${baseUrl}/api`);
                    workingBaseUrl = baseUrl;
                    break;
                } catch (e) {
                    continue;
                }
            }

            if (!workingBaseUrl) {
                addResult('error', 'âŒ', 'æ— æ³•è¿æ¥åˆ°ä»»ä½•åç«¯æœåŠ¡å™¨');
                issues.push({
                    type: 'no_backend',
                    message: 'æ‰€æœ‰åç«¯ç«¯å£(5000, 3001)éƒ½æ— æ³•è¿æ¥',
                    solution: 'start_backend'
                });
                return;
            }

            let apiErrors = [];

            for (const test of apiTests) {
                try {
                    const options = {
                        method: test.method,
                        headers: { 'Content-Type': 'application/json' }
                    };

                    if (test.method === 'POST' && test.data) {
                        options.body = JSON.stringify(test.data);
                    }

                    const response = await fetch(workingBaseUrl + test.url, options);
                    
                    if (response.status === 500) {
                        addResult('error', 'âŒ', `${test.name}: 500é”™è¯¯`);
                        apiErrors.push({ api: test.url, status: 500 });
                        
                        try {
                            const errorData = await response.json();
                            addErrorDetail(errorData.message || 'æœªçŸ¥é”™è¯¯', test.url);
                        } catch (e) {
                            addErrorDetail('æ— æ³•è§£æé”™è¯¯å“åº”', test.url);
                        }
                        
                        issues.push({
                            type: 'api_500_error',
                            message: `${test.name}è¿”å›500é”™è¯¯`,
                            api: test.url,
                            solution: 'check_backend_logs'
                        });
                    } else if (response.status === 404) {
                        addResult('warning', 'âš ï¸', `${test.name}: 404 (å¯èƒ½éœ€è¦è®¤è¯)`);
                    } else if (response.status === 401 || response.status === 403) {
                        addResult('success', 'âœ…', `${test.name}: éœ€è¦è®¤è¯ (æœåŠ¡å™¨æ­£å¸¸)`);
                    } else {
                        addResult('success', 'âœ…', `${test.name}: æ­£å¸¸ (${response.status})`);
                    }
                } catch (error) {
                    addResult('error', 'âŒ', `${test.name}: è¿æ¥å¤±è´¥ - ${error.message}`);
                    apiErrors.push({ api: test.url, error: error.message });
                }
            }

            if (apiErrors.length > 0) {
                const div = document.createElement('div');
                div.className = 'result-box';
                div.innerHTML = `
                    <h4>ğŸ”´ å‘ç° ${apiErrors.length} ä¸ªAPIé”™è¯¯</h4>
                    <pre>${JSON.stringify(apiErrors, null, 2)}</pre>
                `;
                results.appendChild(div);
            }
        }

        function checkBrowserConsole() {
            addResult('checking', 'ğŸ”', 'æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°...');

            const consoleErrors = [];
            const originalError = console.error;
            
            console.error = function(...args) {
                consoleErrors.push(args.join(' '));
                originalError.apply(console, args);
            };

            setTimeout(() => {
                if (consoleErrors.length > 0) {
                    addResult('warning', 'âš ï¸', `å‘ç° ${consoleErrors.length} ä¸ªæ§åˆ¶å°é”™è¯¯`);
                    const div = document.createElement('div');
                    div.className = 'result-box';
                    div.innerHTML = `<h4>æ§åˆ¶å°é”™è¯¯:</h4><pre>${consoleErrors.join('\n')}</pre>`;
                    results.appendChild(div);
                } else {
                    addResult('success', 'âœ…', 'æ§åˆ¶å°æ— é”™è¯¯');
                }
            }, 1000);
        }

        function checkFrontendConfig() {
            addResult('checking', 'ğŸ”', 'æ£€æŸ¥å‰ç«¯é…ç½®...');

            // æ£€æŸ¥API base URLé…ç½®
            const configs = [
                { key: 'VITE_API_BASE_URL', expected: 'http://localhost:5000' },
                { key: 'VITE_APP_TITLE', expected: 'æ˜å‡AIWEB' }
            ];

            const div = document.createElement('div');
            div.className = 'result-box';
            div.innerHTML = `
                <h4>ç¯å¢ƒå˜é‡æ£€æŸ¥:</h4>
                <p><strong>å½“å‰URL:</strong> ${window.location.href}</p>
                <p><strong>APIè°ƒç”¨åº”æŒ‡å‘:</strong> http://localhost:5000/api</p>
            `;
            results.appendChild(div);

            addResult('success', 'âœ…', 'å‰ç«¯é…ç½®æ£€æŸ¥å®Œæˆ');
        }

        function generateSolutions() {
            if (issues.length === 0) {
                addSolution('ç³»ç»Ÿè¿è¡Œæ­£å¸¸', '<p>æœªå‘ç°é—®é¢˜ï¼Œæ‰€æœ‰ç»„ä»¶æ­£å¸¸è¿è¡Œã€‚</p>');
                return;
            }

            // åç«¯æœªè¿è¡Œ
            if (issues.some(i => i.type === 'backend_not_running' || i.type === 'no_backend')) {
                addSolution('å¯åŠ¨åç«¯æœåŠ¡å™¨', `
                    <ol>
                        <li>è¿è¡Œå¯åŠ¨è„šæœ¬: <code>ğŸ”§_å¯åŠ¨åç«¯æœåŠ¡å™¨_2025-12-19.bat</code></li>
                        <li>æˆ–æ‰‹åŠ¨å¯åŠ¨: <code>cd server && node index.js</code></li>
                        <li>ç­‰å¾…çœ‹åˆ°: "æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:5000"</li>
                        <li>é‡æ–°æµ‹è¯•æ­¤é¡µé¢</li>
                    </ol>
                `);
            }

            // API 500é”™è¯¯
            if (issues.some(i => i.type === 'api_500_error')) {
                const errorApis = issues.filter(i => i.type === 'api_500_error').map(i => i.api);
                addSolution('ä¿®å¤API 500é”™è¯¯', `
                    <p><strong>å‡ºé”™çš„API:</strong></p>
                    <ul>${errorApis.map(api => `<li><code>${api}</code></li>`).join('')}</ul>
                    <p><strong>è§£å†³æ­¥éª¤:</strong></p>
                    <ol>
                        <li>æ£€æŸ¥åç«¯æœåŠ¡å™¨çª—å£çš„é”™è¯¯æ—¥å¿—</li>
                        <li>ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸</li>
                        <li>æ£€æŸ¥ <code>server/index.js</code> çš„è·¯ç”±é…ç½®</li>
                        <li>ç¡®è®¤æ‰€æœ‰è·¯ç”±æ–‡ä»¶å·²æ­£ç¡®å¯¼å…¥</li>
                        <li>é‡å¯åç«¯æœåŠ¡å™¨: <code>Ctrl+C</code> ç„¶åé‡æ–°è¿è¡Œ</li>
                    </ol>
                `);
            }

            // å¸¸è§„å»ºè®®
            addSolution('é€šç”¨æ’æŸ¥æ­¥éª¤', `
                <ol>
                    <li><strong>æ¸…é™¤ç¼“å­˜:</strong> Ctrl+Shift+R å¼ºåˆ¶åˆ·æ–°</li>
                    <li><strong>æ£€æŸ¥ç«¯å£:</strong> ç¡®ä¿5000ç«¯å£æœªè¢«å ç”¨</li>
                    <li><strong>æŸ¥çœ‹æ—¥å¿—:</strong> æ£€æŸ¥åç«¯æœåŠ¡å™¨æ§åˆ¶å°è¾“å‡º</li>
                    <li><strong>é‡å¯ç³»ç»Ÿ:</strong> å…ˆå…³é—­æ‰€æœ‰æœåŠ¡å™¨ï¼Œå†é‡æ–°å¯åŠ¨</li>
                    <li><strong>æ£€æŸ¥é˜²ç«å¢™:</strong> ç¡®ä¿é˜²ç«å¢™å…è®¸æœ¬åœ°ç«¯å£è®¿é—®</li>
                </ol>
            `);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        window.onload = function() {
            addResult('success', 'ğŸ‘‹', 'è¯Šæ–­å·¥å…·å·²å°±ç»ªï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­');
        };
    </script>
</body>
</html>

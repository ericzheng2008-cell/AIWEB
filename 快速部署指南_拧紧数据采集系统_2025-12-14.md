# 🚀 拧紧数据采集系统 - 快速部署指南

**版本**: v3.0.0  
**日期**: 2025-12-14  
**适用**: Windows Server / Windows 10/11

---

## 📋 系统要求

### 硬件要求
- **CPU**: 4核心以上
- **内存**: 8GB+ (推荐16GB)
- **硬盘**: 100GB+ 可用空间
- **网络**: 千兆以太网

### 软件要求
- ✅ **Windows Server 2016+** 或 **Windows 10/11**
- ✅ **Node.js** v16.0+ ([下载](https://nodejs.org))
- ✅ **SQL Server 2016+** ([下载](https://www.microsoft.com/sql-server)) 或 **Oracle 12c+**
- ⚠️ **Microsoft Message Queuing (MSMQ)** (可选,Windows功能)

---

## 🔧 安装步骤

### 步骤 1: 安装 SQL Server

1. 下载 SQL Server Express (免费版)
2. 运行安装程序
3. 选择"基本安装"
4. 记录实例名称 (默认: `localhost` 或 `.\SQLEXPRESS`)

**测试连接**:
```cmd
sqlcmd -S localhost -E
```

### 步骤 2: 创建数据库

```cmd
cd C:\Users\EricZ\CodeBuddy\AIWEB1\server\models
sqlcmd -S localhost -E -i create_database.sql
```

**预期输出**:
```
✅ 数据库 ToolsNet8 创建成功
✅ 表 TighteningResults 创建成功 (含5个索引)
✅ 表 TighteningCurves 创建成功 (含外键约束)
...
🎉 ToolsNet 8 数据库初始化完成！
```

### 步骤 3: 安装项目依赖

```cmd
cd C:\Users\EricZ\CodeBuddy\AIWEB1

# 安装后端依赖
cd server
npm install

# 安装前端依赖
cd ..
npm install
```

### 步骤 4: 启动后端服务

```cmd
cd server
npm start
```

**预期输出**:
```
服务器运行在 http://localhost:5000
```

### 步骤 5: 启动前端开发服务器

**打开新的命令行窗口**:

```cmd
cd C:\Users\EricZ\CodeBuddy\AIWEB1
npm run dev
```

**预期输出**:
```
➜  Local:   http://localhost:5173/
```

### 步骤 6: 访问系统

打开浏览器访问:
```
http://localhost:5173/admin/tightening-data
```

---

## 🎯 快速测试

### 测试 1: 生成模拟数据

1. 进入"拧紧数据采集分析"页面
2. 点击"生成模拟数据"按钮
3. 确认生成100条数据
4. 查看统计卡片更新

### 测试 2: 连接控制器 (模拟)

**连接配置**:
- 控制器类型: `PF4000`
- IP地址: `192.168.1.100` (模拟)
- 端口: `4545`
- Protocol版本: `2.8.0`
- 数据库: `sqlserver`
- MSMQ: ✅

点击"连接控制器 (PIM)"

### 测试 3: 启动数据采集

1. 连接成功后,点击"启动数据采集服务 (DCS)"
2. 观察采集速度指标
3. 查看实时数据流

### 测试 4: 数据分析

1. 切换到"数据分析"标签
2. 查看 OK率趋势图
3. 查看扭矩分布图
4. 检查 Cpk 分析结果

### 测试 5: 数据导出

1. 切换到"数据分析"标签
2. 点击"导出数据"按钮
3. 检查下载的 CSV 文件

---

## 🔌 连接真实控制器

### PowerFocus 4000/6000/8000

1. **网络配置**
   - 确保PC与控制器在同一网段
   - 控制器IP: 例如 `192.168.1.100`
   - PC IP: 例如 `192.168.1.10`

2. **控制器设置**
   - 启用 Open Protocol
   - 端口: `4545` (默认)
   - 协议版本: `2.8.0`

3. **测试连接**
```cmd
telnet 192.168.1.100 4545
```

4. **系统连接**
   - 在前端输入真实IP地址
   - 选择对应控制器型号
   - 点击"测试连接"
   - 成功后点击"连接控制器"

### PowerMACS

配置与PowerFocus类似,注意:
- 支持多工位同时采集
- 螺栓编号功能启用
- Batch管理启用

---

## 📊 数据库管理

### 查看数据

使用 SQL Server Management Studio (SSMS):

```sql
-- 查看最近100条拧紧结果
SELECT TOP 100 * 
FROM TighteningResults 
ORDER BY Timestamp DESC;

-- 查看24小时统计
SELECT * FROM vw_Recent24HoursStats;

-- 查看TOP NOK程序
EXEC sp_GetTopNokPrograms @TopN = 10;
```

### 数据备份

```cmd
sqlcmd -S localhost -E -Q "BACKUP DATABASE ToolsNet8 TO DISK='C:\Backup\ToolsNet8.bak'"
```

### 数据清理

```sql
-- 删除30天前的数据
DELETE FROM TighteningResults 
WHERE Timestamp < DATEADD(DAY, -30, GETDATE());
```

---

## 🛠️ 故障排查

### 问题 1: 端口占用

**错误**: `Error: listen EADDRINUSE: address already in use :::5000`

**解决**:
```cmd
# 查找占用进程
netstat -ano | findstr :5000

# 结束进程
taskkill /PID <进程ID> /F
```

### 问题 2: 数据库连接失败

**错误**: `Login failed for user`

**解决**:
1. 检查SQL Server服务是否运行
2. 确认Windows身份验证已启用
3. 使用 `sqlcmd -S localhost -E` 测试

### 问题 3: 无法连接控制器

**错误**: `连接超时`

**解决**:
1. 检查网络连通性: `ping 192.168.1.100`
2. 检查防火墙设置
3. 确认控制器Open Protocol已启用
4. 使用Telnet测试端口: `telnet 192.168.1.100 4545`

### 问题 4: 数据未更新

**原因**: 前端缓存

**解决**:
1. 清除浏览器缓存 (Ctrl+Shift+Delete)
2. 清除localStorage:
```javascript
// 在浏览器控制台执行
localStorage.clear()
location.reload()
```

---

## 🔒 安全配置

### 1. 启用HTTPS

修改 `vite.config.js`:
```javascript
export default {
  server: {
    https: true,
    // 证书配置...
  }
}
```

### 2. 配置CORS

修改 `server/index.js`:
```javascript
app.use(cors({
  origin: 'https://your-domain.com',
  credentials: true
}));
```

### 3. 数据库用户权限

创建专用数据库用户:
```sql
CREATE LOGIN ToolsNetUser WITH PASSWORD = 'YourStrongPassword!';
USE ToolsNet8;
CREATE USER ToolsNetUser FOR LOGIN ToolsNetUser;
GRANT SELECT, INSERT, UPDATE, DELETE ON SCHEMA::dbo TO ToolsNetUser;
```

---

## 📈 性能优化

### 1. 数据库索引优化

```sql
-- 检查缺失索引
SELECT * FROM sys.dm_db_missing_index_details;

-- 重建索引
ALTER INDEX ALL ON TighteningResults REBUILD;
```

### 2. 清理历史数据

创建定时任务:
```sql
-- 每月归档3个月前的数据
CREATE PROCEDURE sp_ArchiveOldData
AS
BEGIN
    INSERT INTO TighteningResults_Archive
    SELECT * FROM TighteningResults
    WHERE Timestamp < DATEADD(MONTH, -3, GETDATE());
    
    DELETE FROM TighteningResults
    WHERE Timestamp < DATEADD(MONTH, -3, GETDATE());
END
```

### 3. 启用数据压缩

```sql
ALTER TABLE TighteningResults REBUILD WITH (DATA_COMPRESSION = PAGE);
```

---

## 🔄 系统更新

### 更新代码

```cmd
cd C:\Users\EricZ\CodeBuddy\AIWEB1
git pull origin main
npm install
cd server
npm install
```

### 更新数据库

```cmd
cd server/models
sqlcmd -S localhost -E -i update_database_v3.1.0.sql
```

---

## 📞 技术支持

### 日志文件位置

- **后端日志**: `server/logs/app.log`
- **数据库日志**: SQL Server错误日志
- **浏览器控制台**: F12 → Console

### 联系方式

- **文档**: 本文件
- **API文档**: `server/routes/tightening.js`
- **数据库文档**: `server/models/database.js`

---

## ✅ 部署检查清单

部署前请确认:

- [ ] SQL Server已安装并运行
- [ ] 数据库 ToolsNet8 已创建
- [ ] 所有数据表已创建(7张)
- [ ] Node.js环境已配置
- [ ] 后端依赖已安装
- [ ] 前端依赖已安装
- [ ] 后端服务启动成功 (端口5000)
- [ ] 前端服务启动成功 (端口5173)
- [ ] 可访问前端页面
- [ ] 模拟数据测试通过
- [ ] 数据导出功能正常

---

## 🎉 部署完成

恭喜！系统部署完成。

**下一步**:
1. 配置真实控制器连接
2. 设置报警规则
3. 配置用户权限
4. 定期备份数据库

**开始使用**: http://localhost:5173/admin/tightening-data

---

**最后更新**: 2025-12-14  
**版本**: v3.0.0
